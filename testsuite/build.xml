<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE project [
   <!ENTITY libraries SYSTEM "../thirdparty/libraries.ent">
   <!ENTITY testsuite-libraries SYSTEM "../thirdparty/testsuite-libraries.ent">
   <!ENTITY modules SYSTEM "../tools/etc/buildmagic/modules.ent">
]>

<!-- ============================================================ -->
<!--  JBoss, the OpenSource J2EE webOS                            -->
<!--  Distributable under LGPL license.                           -->
<!--  See terms of license at http://www.gnu.org.                 -->
<!-- ============================================================ -->

<!-- $Id: build.xml 89210 2009-05-20 19:13:59Z anil.saldhana@jboss.com $ -->

<project default="main" name="JBoss/Testsuite"
         xmlns:server="http://jboss.org/ns/test/ant/server">
   <import file="../tools/etc/buildmagic/build-common.xml"/>

   <!-- Tests requiring separate server configurations -->
   <import file="imports/config/configs.xml"/>

   <!-- ======================================================== -->
   <!-- Initialization                                           -->
   <!-- ======================================================== -->
   <tstamp>
      <format property="TIMENOW" pattern="yyyy-MM-dd.HH-mm" timezone="GMT"/>
   </tstamp>
   <echo message="${TIMENOW}" file="run.tstamp"/>

   <property name="results_web" value="http://jboss.sourceforge.net/junit-results/32"/>
   <property name="buildlog.level" value="info" />
   <property environment="env"/>

   <!-- Set a hostname property based on COMPUTERNAME for win32, HOSTNAME
   otherwise and initialize the node0/node1 cluster hostnames to localhost
   and ${hostname} by default. If you cannot route multicast traffic between
   localhost and hostname, then you need to specify node0 and node1 binding
   in the local.properties that can in order to be able to run the clustering
   tests.
   -->
   <condition property="hostname" value="${env.COMPUTERNAME}">
      <os family="windows"/>
   </condition>
   <condition property="hostname" value="${env.HOSTNAME}">
      <not>
         <os family="windows"/>
      </not>
   </condition>

   <!--We will use local.properties file to provide some configuration
       to the testsuite mainly for the Clustering framework. Please
       do not checkin your local.properties file into CVS-->
   <property file="local.properties"/>

   <!-- Set a property if we know this is a Sun VM. Can be
        used to enable/disable things based on VM vendor -->
   <condition property="sun-vm" value="true">
   	  <and>
         <equals arg1="Sun Microsystems Inc." arg2="${java.vendor}" trim="true"/>
   	  	 <not>
   	  	 	<!-- Pass -Dignore.sun-vm.override=true to ant to bypass
   	  	 	     enabling/disabling things based on Sun being VM vendor -->
   	  	 	<isset property="ignore.sun-vm.override"/>
   	  	 </not>
   	  </and>
   </condition>

   <!-- Cluster node0 defaults -->
   <property name="node0" value="localhost" />
   <property name="node0.http.url" value="http://${node0}:8080" />
   <property name="node0.jndi.url" value="jnp://${node0}:1099" />
   <property name="node0.hajndi.url" value="jnp://${node0}:1100" />
   <property name="node0.jndi.http.url" value="http://${node0}:8080/invoker/JNDIFactory" />
   <!-- Cluster node1 defaults -->
   <property name="node1" value="${hostname}" />
   <property name="node1.http.url" value="http://${node1}:8080" />
   <property name="node1.jndi.url" value="jnp://${node1}:1099" />
   <property name="node1.hajndi.url" value="jnp://${node1}:1100" />
   <property name="node1.jndi.http.url" value="http://${node1}:8080/invoker/JNDIFactory" />

   <!-- UDP Group -->
   <!-- The value of the -u option passed to jboss -->
   <!-- A blank value will prevent the -u option from being passed -->
   <!-- Override this in the local.properties or pass to Ant as -DupdGroup=128.x.x.x -->
   <property name="udpGroup" value=""/>
   <!-- Same thing, but passed to the client -->
   <property name="jbosstest.udpGroup" value="${udpGroup}"/>
  
   <!-- PartitionName -->
   <!-- The value of the -g option passed to jboss in some configs -->
   <!-- Override this in the local.properties or pass to Ant as -DpartitionName=FooPartition -->
   <property name="partitionName" value="DefaultPartition"/>
   <!-- Same thing, but passed to the client -->
   <property name="jbosstest.partitionName" value="${partitionName}"/>

   <!-- =================== -->
   <!-- Basic Configuration -->
   <!-- =================== -->

   <!-- Module name(s) & version -->
   <property name="module.name" value="testsuite"/>
   <property name="module.Name" value="JBoss Testsuite"/>
   <property name="module.version" value="DEV"/>

   <!-- ========= -->
   <!-- Libraries -->
   <!-- ========= -->

   &libraries;
   &testsuite-libraries;

   <!-- The combined library classpath -->
   <path id="library.classpath">
      <path refid="apache.avalon.classpath"/>
      <path refid="apache.commons.classpath"/>
      <path refid="apache.codec.classpath"/>
      <path refid="apache.log4j.classpath"/>
      <path refid="apache.jaxme.classpath"/>
      <path refid="apache.scout.classpath"/>
      <path refid="apache.xerces.classpath"/>
      <path refid="org.apache.classpath"/>
      <path refid="dom4j.dom4j.classpath"/>
      <path refid="httpunit.httpunit.classpath"/>
      <path refid="ibm.wsdl4j.classpath"/>
      <path refid="jacorb.jacorb.classpath"/>
      <path refid="jboss.cache.jbosscache.core.classpath"/>
      <path refid="jboss.cache.jbosscache.pojo.classpath"/>
      <path refid="jgroups.jgroups.classpath"/>
      <path refid="joesnmp.joesnmp.classpath"/>
      <path refid="junit.junit.classpath"/>
      <path refid="org.easymock.classpath"/>
      <path refid="javassist.classpath"/>
      <path refid="juddi.juddi.classpath"/>
      <path refid="nekohtml.nekohtml.classpath"/>
      <path refid="objectweb.joramtests.classpath"/>
      <path refid="opensaml.opensaml.classpath"/>
      <path refid="oswego.concurrent.classpath"/>
      <path refid="sleepycat.classpath"/>
      <path refid="sun.jaf.classpath"/>
      <path refid="sun.javamail.classpath"/>
      <path refid="sun.jaxb.classpath"/>
      <path refid="sun.jsf.classpath"/>
      <path refid="jboss.web.classpath"/>
      <path refid="trove.classpath"/>
      <path refid="wutka.dtdparser.classpath"/>
      <path refid="woodstox.woodstox.classpath"/>
      <path refid="org.jboss.cluster.classpath"/>
      <path refid="org.jboss.jaxr.classpath"/>
      <path refid="jboss.remoting.classpath"/>
      <path refid="jboss.serialization.classpath"/>
      <path refid="jboss.jboss.ejb3.core.classpath" />
      <path refid="jboss.jboss.ejb3.ext.api.classpath" />
      <path refid="jboss.jboss.ejb3.proxy.impl.classpath" />
      <path refid="jboss.jboss.ejb3.proxy.spi.classpath" />
      <path refid="ejb3-persistence.classpath"/>
      <path refid="org.jboss.ws.native.classpath"/>
      <path refid="org.jboss.ws.classpath"/>
      <path refid="jboss.jbossxb.classpath"/>
      <path refid="jboss.metadata.classpath"/>
      <path refid="jboss.integration.classpath"/>
      <path refid="jboss.profileservice.spi.classpath"/>
      <path refid="stax.api.classpath"/>
      <!-- needed for messaging JMS provider tests -->
      <path refid="jboss.messaging.classpath"/>
      <!-- needed for proxy tests -->
      <path refid="apache.bcel.classpath"/>
      <!-- needed for security login module tests -->
      <path refid="hsqldb.hsqldb.classpath"/>
      <!-- Need hibernate jar for hibernate-based tests -->
      <path refid="hibernate3.classpath"/>
      <path refid="odmg.classpath"/>
      <path refid="cglib.classpath"/>
     <!-- Need spring jar for spring-based tests -->
     <path refid="spring.classpath"/>

      <!-- xml binding -->
      <path refid="xmlunit.xmlunit.classpath"/>
      <path refid="jboss.jboss.reflect.classpath"/>
      <path refid="jboss.jboss.mdr.classpath"/>
      <path refid="jboss.jboss.man.classpath"/>
      <path refid="jboss.jboss.deployers.classpath"/>
      <path refid="jboss.jboss.cl.classpath"/>
      <path refid="jboss.microcontainer.classpath"/>

   	  <!-- For classloader leak tests -->
      <path refid="jboss.profiler.jvmti.classpath"/>
			
      <!-- org.jboss.aspects:jboss-aspects -->
      <path refid="org.jboss.aspects.classpath"/>
      <!-- hibernate tests need slfj4 -->
      <path refid="org.jboss.slf4j.classpath"/>
      <path refid="org.slf4j.classpath"/>

   </path>

   <!-- ======= -->
   <!-- Modules -->

   &modules;

   <!-- ======= -->
   <!-- InternalServer -->
   <!-- This could be a mistake.  Perhaps, though, it would be a good idea to separate
   tests that need internal jboss classes from those that don't.  When I put it in, only
   the jca XATxConnectionManagerUnitTestCase needed an internal class (the tx manager)-->
   <property name="jboss.internal-server.root" value="${project.root}/server/output"/>
   <property name="jboss.internal-server.lib" value="${jboss.internal-server.root}/lib"/>
   <path id="jboss.internal-server.classpath">
      <pathelement path="${jboss.server.lib}/jboss.jar"/>
      <pathelement path="${jboss.server.lib}/jboss-main.jar"/>
      <pathelement path="${jboss.server.lib}/jboss-system.jar"/>
   </path>

   <!-- The combined dependant module classpath -->
   <path id="dependentmodule.classpath">
      <path refid="jboss.aop.classpath"/>
      <path refid="jboss.aspects.classpath"/>
      <path refid="jboss.cluster.classpath"/>
      <path refid="jboss.common.core.classpath"/>
      <path refid="jboss.common.logging.spi.classpath"/>
      <path refid="jboss.common.logging.log4j.classpath"/>
      <path refid="jboss.common.logging.jdk.classpath"/>
      <path refid="jboss.deployment.classpath"/>
      <path refid="jboss.hibernate.classpath"/>
      <path refid="jboss.iiop.classpath"/>
      <path refid="jboss.internal-server.classpath"/>
      <path refid="jboss.j2se.classpath"/>
      <path refid="jboss.jboss.jaspi.api.classpath"/>
      <path refid="jboss.jboss.javaee.classpath"/>
      <path refid="org.jboss.javaee.classpath"/>
      <path refid="jboss.jboss.vfs.classpath"/>
      <path refid="jboss.jca.classpath"/>
      <path refid="jboss.jmx.classpath"/>
      <path refid="jboss.jmx-remoting.classpath"/>
      <path refid="jboss.management.classpath"/>
      <path refid="jboss.mbeans.classpath"/>
      <path refid="jboss.mq.classpath"/>
      <path refid="jboss.jnpserver.classpath"/>
      <path refid="jboss.profileservice.classpath"/>
      <path refid="jboss.jboss.security.spi.classpath"/>
      <path refid="jboss.jbosssx.classpath"/>
      <path refid="jboss.security.int.classpath"/>
      <path refid="jboss.server.classpath"/>
      <path refid="jboss.main.classpath"/>
      <path refid="jboss.jboss.bootstrap.classpath"/>
      <path refid="jboss.system.classpath"/>
      <path refid="jboss.systemjmx.classpath"/>
      <path refid="jboss.test.classpath"/>
      <path refid="jboss.tomcat.classpath"/>
      <path refid="jboss.varia.classpath"/>
      <path refid="jboss.web.classpath"/>
      <path refid="jboss.spring.classpath"/>
   </path>

   <!-- RMI Stub generation -->
   <patternset id="rmic.includes"
      description="The patternset passed to the compile-stubs target">
      <include name="org/jboss/test/cluster/test/DistributedStateTestCase$TestListener.class"/>
      <include name="org/jboss/test/cluster/test/DRMTestCase$TestListener.class"/>
      <include name="org/jboss/test/cts/test/ClientCallbackImpl.class"/>
      <include name="org/jboss/test/jmx/invoker/RMIBadListener.class"/>
      <include name="org/jboss/test/jmx/invoker/RMIListener.class"/>
   </patternset>

   <!-- ===== -->
   <!-- Tasks -->
   <!-- ===== -->

   <!-- Where source files live -->
   <property name="source.java" value="${module.source}/main"/>
	 <property name="source.java.5" value="${module.source}/jdk15"/>
   <property name="source.etc" value="${module.source}/etc"/>
   <property name="source.docs" value="${module.source}/docs"/>
   <property name="source.resources" value="${module.source}/resources"/>
   <property name="source.stylesheets" value="${module.source}/stylesheets"/>

   <!-- Where build generated files will go -->
   <property name="build.classes" value="${module.output}/classes"/>
   <property name="build.lib" value="${module.output}/lib"/>
   <property name="build.api" value="${module.output}/api"/>
   <property name="build.etc" value="${module.output}/etc"/>
   <property name="build.docs" value="${module.output}/docs"/>
   <property name="build.resources" value="${module.output}/resources"/>
   <property name="build.stylesheets" value="${module.output}/stylesheets"/>
   <property name="build.reports" value="${module.output}/reports"/>
   <!--<property name="build.testlog" value="${java.io.tmpdir}"/>-->
   <property name="build.testlog" value="${module.output}/log"/>
   <property name="build.gen-src" value="${module.output}/gen-src/"/>

   <!-- Install/Release structure -->
   <property name="install.id" value="${module.name}-${module.version}"/>
   <property name="release.id" value="${install.id}"/>
   <property name="install.root" value="${module.output}/${install.id}"/>

   <!-- The combined thirdparty classpath -->
   <path id="thirdparty.classpath">
      <path refid="library.classpath"/>
      <path refid="dependentmodule.classpath"/>
   </path>

   <path id="javac.classpath">
      <path refid="thirdparty.classpath"/>
   </path>

   <!-- classpath and local.classpath must have a value using with a path -->
   <property name="classpath" value=""/>
   <property name="local.classpath" value=""/>

   <!-- Classpath to build and run the tests -->
   <path id="tests.compile.classpath">
      <pathelement path="${classpath}"/>
      <pathelement path="${local.classpath}"/>
      <pathelement path="${project.tools}/lib/ant.jar"/>
      <pathelement path="${project.tools}/lib/ant-junit.jar"/>
      <path refid="jboss.ejb3.classpath"/>
      <path refid="jboss.jmx.classpath"/>
      <path refid="jboss.jmx-remoting.classpath"/>
      <path refid="jboss.test.classpath"/>
      <path refid="jboss.tomcat.classpath"/>
      <path refid="thirdparty.classpath"/>
   </path>

   <!-- Import the jboss server run targets -->
   <import file="imports/server-config.xml"/>

   <!-- Classpath to build and run the tests -->
   <path id="tests.classpath">
     <fileset dir="${jboss.dist}/client">
       <include name="**/*.jar"/>
        <exclude name="jaxws-rt.jar"/>
        <exclude name="jaxws-tools.jar"/>
      </fileset>

      <pathelement path="${classpath}"/>
      <pathelement path="${local.classpath}"/>
      <pathelement path="${project.tools}/lib/ant.jar"/>
      <pathelement path="${project.tools}/lib/ant-junit.jar"/>
      <path refid="jboss.ejb3.classpath"/>
      <path refid="jboss.jmx.classpath"/>
      <path refid="jboss.jmx-remoting.classpath"/>
      <path refid="jboss.test.classpath"/>
      <path refid="thirdparty.classpath"/>
   </path>

   <!-- The classpath required to build javadocs. -->
   <path id="javadoc.classpath">
      <path refid="tests.compile.classpath"/>
   </path>

   <!-- Packages to include when generating api documentation -->
   <property name="javadoc.packages" value="org.jboss.*"/>

   <!-- Override JUnit defaults -->
   <property name="junit.timeout" value="180000"/> <!-- 3 minutes -->
   <property name="jbosstest.iterationcount" value="10"/>
   <property name="jbosstest.threadcount" value="5"/>
   <property name="jbosstest.beancount" value="5"/>
   <property name="jbosstest.nodeploy" value="false"/>
   <property name="jbosstest.src.etc" value="${source.etc}"/>
   <property name="junit.batchtest.todir" value="${build.reports}"/>
   <property name="junit.jvm.options" value="-Ddummy"/>
   <!-- Override JUnit Marathon defaults -->
   <property name="marathon.timeout" value="3900000"/> <!-- 65 minutes -->
   <property name="marathon.duration" value="3600000"/> <!-- 60 minutes -->
   <property name="marathon.threadcount" value="100"/>
   <propertyset id="jbosstest-props">
      <propertyref prefix="jbosstest."/>
   </propertyset>

   <target name="init">
      <record name="${basedir}/build.log" append="yes" action="start" loglevel="error"/>
      <mkdir dir="${build.gen-src}/org/jboss/test/cts/ejb"/>
      <mkdir dir="${build.gen-src}/org/jboss/test/cts/interfaces"/>
      <mkdir dir="${build.gen-src}/org/jboss/test/cts/service"/>
      <copy
         tofile="${build.gen-src}/org/jboss/test/cts/interfaces/CtsCmp2Local.java"
         file="${source.java}/org/jboss/test/cts/interfaces/CtsCmp2Local_V1.txt"
         overwrite="false"/>
      <copy tofile="${build.gen-src}/org/jboss/test/cts/ejb/CtsCmp2Bean.java"
         file="${source.java}/org/jboss/test/cts/ejb/CtsCmp2Bean_V1.txt"
         overwrite="flase"/>
      <copy
         tofile="${build.gen-src}/org/jboss/test/cts/service/CtsCmpService.java"
         file="${source.java}/org/jboss/test/cts/service/CtsCmpService_V1.txt"
         overwrite="false"/>
      <mkdir dir="${build.gen-src}/org/jboss/test/classloader/scoping/singleton"/>
      <copy tofile="${build.gen-src}/org/jboss/test/classloader/scoping/singleton/MySingleton.java"
            file="${source.java}/org/jboss/test/classloader/scoping/singleton/MySingleton_V1.txt" overwrite="false"/>
   </target>

   <!-- retrieve items from the repository, store them in the -->
   <!-- thirdparty folder, and create a testsuite-libraries.ent file -->
   <!-- then generate a new libraries.ent file and include it in  -->
   <!-- the build                                                 -->
   <target name="createthirdparty" unless="inhibit.downloads"
      depends="check.inhibit.downloads, set.proxy">
      <condition property="mvn.cmd" value="mvn.bat" else="mvn">
         <os family="windows"/>
      </condition>
      <exec executable="${mvn.cmd}" dir="../thirdparty">
        <arg line="package"/>
      </exec>
   </target>

   <!-- check if thirdparty libraries are to be downloaded -->
   <target name="check.inhibit.downloads">
      <condition property="inhibit.downloads">
         <or>
            <uptodate property="dependencies.current"
	          srcfile="../pom.xml"
               targetfile="../thirdparty/testsuite-libraries.ent"/>
            <istrue value="${nodownload}"/>
         </or>
      </condition>
  </target>

  <!-- check if the the user has specied proxy settings -->
  <target name="check.proxy">
    <condition property="hasproxy">
        <and>
            <isset property="proxy.host"/>
            <isset property="proxy.port"/>
            <not>
                <equals arg1="" arg2="${proxy.host}" trim="true"/>
            </not>
            <not>
                <equals arg1="" arg2="${proxy.port}" trim="true"/>
            </not>
        </and>
    </condition>
  </target>

  <!-- set proxy settings -->
  <target name="set.proxy" if="hasproxy" depends="check.proxy">
    <echo>Proxy is set to ${proxy.host}:${proxy.port}</echo>
    <setproxy proxyhost="${proxy.host}" proxyport="${proxy.port}"/>
  </target>

   <!-- ================================================================== -->
   <!-- Compile                                                            -->
   <!-- ================================================================== -->
   <import file="imports/code-generation.xml"/>

   <!--
      |  Compile everything.
      |
      |  This target should depend on other compile-* targets for each
      |  different type of compile that needs to be performed, short of
      |  documentation compiles.
     -->
   <target name="compile"
      depends="init, compile-classes, compile-xmbean-dds, compile-stubs, compile-etc, compile-stylesheets, compile-resources"
      description="Compile all source files."/>

   <!-- Compile all class files -->
   <target name="compile-classes" depends="compile-bean-sources, compile-mbean-sources, compile-proxycompiler-bean-sources, compile-classes-only">
   </target>

   <target name="compile-annotated-classes-50" if="HAVE_JDK_1.5">
     <mkdir dir="${build.classes}"/>

     <javac destdir="${build.classes}"
       optimize="${javac.optimize}"
       source="1.5"
       target="1.5"
       debug="${javac.debug}"
       depend="${javac.depend}"
       verbose="${javac.verbose}"
       deprecation="${javac.deprecation}"
       includeAntRuntime="${javac.include.ant.runtime}"
       includeJavaRuntime="${javac.include.java.runtime}"
       failonerror="${javac.fail.onerror}">
       <src path="${source.java.5}"/>
       <classpath refid="tests.compile.classpath"/>
         <include name="org/jboss/test/aop/**"/>
     </javac>

      <!-- The aop tests use JDK 5 annotations, so make sure that the jboss-aop-jdk50.jar comes before the JDK1.4 style annotations defined in jboss-messaging-client.jar  -->
      <path id="annotations.classpath">
         <path refid="jboss.aop.classpath"/>
         <path refid="tests.compile.classpath"/>
      </path>

     <javac destdir="${build.classes}"
       optimize="${javac.optimize}"
       source="1.5"
       target="1.5"
       debug="${javac.debug}"
       depend="${javac.depend}"
       verbose="${javac.verbose}"
       deprecation="${javac.deprecation}"
       includeAntRuntime="${javac.include.ant.runtime}"
       includeJavaRuntime="${javac.include.java.runtime}"
       failonerror="${javac.fail.onerror}">
       <src path="${source.java}"/>
       <classpath refid="annotations.classpath"/>
         <include name="org/jboss/test/aop/**"/>
     </javac>

   </target>

   <target name="compile-classes-only" depends="compile-annotated-classes-50">
      <mkdir dir="${build.classes}"/>
      <javac destdir="${build.classes}"
         optimize="${javac.optimize}"
         source="${javac.source}"
         target="${javac.target}"
         debug="${javac.debug}"
         depend="${javac.depend}"
         verbose="${javac.verbose}"
         deprecation="${javac.deprecation}"
         includeAntRuntime="${javac.include.ant.runtime}"
         includeJavaRuntime="${javac.include.java.runtime}"
         failonerror="${javac.fail.onerror}">
         <src path="${source.java}"/>
         <src path="${build.gen-src}"/>
         <exclude name="org/jboss/test/recover/oracle/**"/>
         <exclude name="org/jboss/test/recover/derby/**"/>
         <exclude name="org/jboss/test/xml/JaxpXPathBaseTestCase*" if="HAVE_JDK_1.4"/>
         <exclude name="org/jboss/test/aop/**"/>
         <classpath refid="tests.compile.classpath"/>
      </javac>
   </target>

   <target name="compile-stubs">
      <rmic base="${build.classes}"
         sourcebase="${build.classes}"
         verify="${rmic.verify}"
         iiop="${rmic.iiop}"
         iiopopts="${rmic.iiopopts}"
         idl="${rmic.idl}"
         idlopts="${rmic.idlops}"
         debug="${rmic.debug}"
         stubVersion="${rmic.stubVersion}"
         >
         <classpath refid="tests.compile.classpath"/>
         <patternset refid="rmic.includes" />
      </rmic>
   </target>

   <!-- Compile resource files -->
   <target name="compile-resources">
      <mkdir dir="${build.resources}"/>
      <copy todir="${build.resources}" filtering="no">
         <fileset dir="${source.resources}">
            <exclude name="webservice/**"/>
            <include name="**/*"/>
         </fileset>
      </copy>
   </target>

   <!-- Compile stylesheets files -->
   <target name="compile-stylesheets">
      <mkdir dir="${build.stylesheets}"/>
      <copy todir="${build.stylesheets}" filtering="yes">
         <fileset dir="${source.stylesheets}">
            <include name="**/*"/>
         </fileset>
      </copy>
   </target>

   <!-- Compile etc files (manifests and such) -->
   <target name="compile-etc">
      <mkdir dir="${build.etc}"/>
      <copy todir="${build.etc}" filtering="yes">
         <fileset dir="${source.etc}">
            <include name="**/*"/>
         </fileset>
      </copy>
   </target>


   <!-- Import the test jars build targets -->
   <import file="imports/test-jars.xml"/>

   <!-- Propagate the dist directory as a jbosstest system property -->
   <property name="jbosstest.dist" value="${jboss.dist}"/>

   <!-- ================================================================== -->
   <!-- Cleaning                                                           -->
   <!-- ================================================================== -->

   <!-- Clean up all build output -->
   <target name="clean" depends="_default:clean"
      description="Cleans up most generated files."/>

   <!-- Clean up all build output -->
   <target name="clobber" depends="_default:clobber"
     description="Cleans up all generated files.">
   </target>

   <!-- ================================================================== -->
   <!-- Misc.                                                              -->
   <!-- ================================================================== -->

   <target name="main"
      description="Executes the default target (most)."
      depends="createthirdparty,most"/>

   <target name="all"
      description="Builds everything."
      depends="jars"/>

   <target name="most"
      description="Builds almost everything."
      depends="jars"/>

   <target name="help" description="Displays the project help">
      <echo>
         The main targets are:
         + jars : compile the tests and build the test jars
         + tests : the main tests entry points which runs all normal unit tests
         Use ant -projecthelp to list all documented targets.
      </echo>
   </target>

   <!-- ================================================================== -->
   <!-- Tests                                                              -->
   <!-- ================================================================== -->

   <macrodef name="wait-on-host">
      <attribute name="seconds" default="240"/>
      <attribute name="host" default="${node0}"/>
      <sequential>
         <echo message="Waiting for @{host} to start..."/>
         <waitfor maxwait="@{seconds}" maxwaitunit="second"
            checkevery="5" checkeveryunit="second" timeoutproperty="startup.timeout">
            <http url="http://@{host}:8080/"/>
         </waitfor>
         <fail message="Timeout waiting for nodes to start" if="startup.timeout"/>
      </sequential>
   </macrodef>

   <macrodef name="wait-on-shutdown">
      <attribute name="seconds" default="240"/>
      <attribute name="conf"/>
      <attribute name="serverlog" default="${jboss.dist}/server/@{conf}/log/server.log"/>
      <sequential>
         <echo message="Waiting for '@{conf}' server to stop..."/>
         <waitfor maxwait="@{seconds}" maxwaitunit="second"
            checkevery="5" checkeveryunit="second" timeoutproperty="shutdown.timeout">
            <available file="@{serverlog}">
               <filepath>
                  <fileset dir="${jboss.dist}/server/@{conf}/log/" includes="server.log">
                     <contains text="[org.jboss.bootstrap.microcontainer.ServerImpl] (JBoss Shutdown Hook) Shutdown complete"/>
                  </fileset>
               </filepath>
            </available>
         </waitfor>
         <fail message="Timeout waiting for '@{conf}' server to shutdown." if="shutdown.timeout"/>
      </sequential>
   </macrodef>

   <!-- patternsets for specialized configs -->
   
   <!-- Make the "test" system property a patternset -->
   <patternset id="one.test.includes">
      <include name="${test}"/>
   </patternset>
   <patternset id="binding-manager.includes">
     <include name="org/jboss/test/binding/*TestCase.class"/>
   </patternset>
   <patternset id="binding-manager.excludes">
     <exclude name="org/jboss/test/binding/*TestCase.class"/>
   </patternset>
   <!-- The compatibility tests need extra memory -->
   <patternset id="compatibility.includes">
     <include name="org/jboss/test/compatibility/test/*TestCase.class"/>
   </patternset>
   <patternset id="compatibility.excludes">
     <exclude name="org/jboss/test/compatibility/test/*TestCase.class"/>
   </patternset>
   <!-- Tests needing deployment service setup -->
   <patternset id="deployment-service.includes">
      <include name="org/jboss/test/deployment/test/*TestCase.class"/>
   </patternset>
   <patternset id="deployment-service.excludes">
      <exclude name="org/jboss/test/deployment/test/*TestCase.class"/>
   </patternset>
   <!-- Tests needing IIOP setup -->
   <patternset id="iiop.includes">
      <include name="org/jboss/test/*iiop/test/*TestCase.class"/>
      <exclude name="org/jboss/test/txiiop/test/*TestCase.class"/>
   </patternset>
   <patternset id="iiop.excludes">
      <exclude name="org/jboss/test/*iiop/test/*"/>
   </patternset>
   <!-- A patternset that requires jboss to run with a JACC security manager -->
   <patternset id="jacc.includes">
      <include name="**/test/jacc/test/*TestCase.class"/>
      <include name="org/jboss/test/web/test/UserInRoleUnitTestCase.class" />
      <include name="org/jboss/test/cmp2/audit/test/*TestCase.class" />
      <include name="org/jboss/test/cmp2/commerce/*TestCase.class" />
      <include name="org/jboss/test/cmp2/cmrstress/*TestCase.class" />
      <include name="org/jboss/test/cmp2/cmrtransaction/test/*TestCase.class" />
      <include name="org/jboss/test/cmp2/perf/test/*TestCase.class" />
      <include name="org/jboss/test/cmp2/relationship/*TestCase.class" />
      <include name="org/jboss/test/cmp2/simple/SimpleUnitTestCase.class" />
      <include name="**/test/webservice/jbws309/*TestCase.class"/>
   </patternset>
   <patternset id="jacc.excludes">
	<exclude name="**/test/jacc/test/*"/>
   </patternset>
   <patternset id="jacc.allstarrole.includes">
      <include name="org/jboss/test/jacc/test/allstarrole/*TestCase.class"/>
   </patternset>

   <patternset id="ldap.includes">
      <include name="**/test/security/test/opends/*TestCase.class"/>
   </patternset>
   <patternset id="jaxr.includes">
      <include name="org/jboss/test/jaxr/scout/**/*TestCase.class"/>
   </patternset>
   <!-- jbossmessaging includes -->
   <patternset id="jbossmessaging.includes">
     <include name="org/jboss/test/jbossmessaging/test/*UnitTestCase.class"/>
     <include name="org/jboss/test/jbossmessaging/perf/*StressTestCase.class"/>
     <include name="org/jboss/test/jbossmessaging/ra/*UnitTestCase.class"/>
     <include name="org/jboss/test/jms/integration/**/*Test.class"/>
   </patternset>
   <patternset id="jbossmessaging-clustering.includes">
     <include name="org/jboss/test/jbossmessaging/clustertest/*TestCase.class"/>
   </patternset>
   <!-- jbossmessaging excludes -->
   <patternset id="jbossmessaging.excludes">
     <exclude name="org/jboss/test/jbossmessaging/test/*UnitTestCase.class"/>
     <exclude name="org/jboss/test/jbossmessaging/perf/*StressTestCase.class"/>
     <exclude name="org/jboss/test/jbossmessaging/ra/*UnitTestCase.class"/>
     <exclude name="org/jboss/test/jms/integration/**/*Test.class"/>
   </patternset>
   <!-- Tests needing xml binding setup -->
   <patternset id="jbossxb.includes">
      <include name="org/jboss/test/xml/*TestCase.class"/>
   </patternset>
   <patternset id="jbossxb.excludes">
   </patternset>
   <!-- Tests needing jrmp invoker -->
   <patternset id="jrmp-invoker.includes">
      <include name="org/jboss/test/cts/test/BmpUnitTestCase.class"/>
      <!--include name="org/jboss/test/cts/test/ClientCallbackImpl.class"/-->
      <include name="org/jboss/test/cts/test/CmpUnitTestCase.class"/>
      <include name="org/jboss/test/cts/test/CtsCmp2UnitTestCase.class"/>
      <include name="org/jboss/test/cts/test/IndependentJarsUnitTestCase.class"/>
      <include name="org/jboss/test/cts/test/LocalEjbTestCase.class"/>
      <include name="org/jboss/test/cts/test/LongWaitStatefulSessionUnitTestCase.class"/>
      <!--include name="org/jboss/test/cts/test/MDBInvoker.class"/-->
      <!--include name="org/jboss/test/cts/test/MDBUnitTestCase.class"/-->
      <!--include name="org/jboss/test/cts/test/SessionInvoker.class"/-->
      <include name="org/jboss/test/cts/test/StatefulSessionLocalUnitTestCase.class"/>
      <include name="org/jboss/test/cts/test/StatefulSessionUnitTestCase.class"/>
      <include name="org/jboss/test/cts/test/StatelessSessionStressTestCase.class"/>
      <include name="org/jboss/test/cts/test/StatelessSessionUnitTestCase.class"/>
      <include name="org/jboss/test/bank/test/BankEJB20StressTestCase.class"/>
      <include name="org/jboss/test/testbean/test/BeanUnitTestCase.class"/>
    </patternset>
    <patternset id="jrmp-invoker.excludes">
       <exclude name="org/jboss/test/bank/test/*"/>
    </patternset>
   <!-- A patternset for that require a security config -->
   <patternset id="security.includes">
      <include name="**/test/naming/test/Security*"/>
      <include name="**/test/security/test/*UnitTestCase.class"/>
      <include name="**/test/security/test/auth/*UnitTestCase.class"/>
      <include name="**/test/security/test/authorization/*UnitTestCase.class"/>
      <include name="**/test/security/test/mapping/**/*TestCase.class"/>
      <include name="**/test/web/security/authorization/XACML*UnitTestCase.class"/>
      <include name="**/test/jca/test/SecurityContextUnitTestCase.class"/>
      <include name="**/test/jmx/test/Secure*TestCase.class"/>
      <include name="**/test/jmx/test/RMIAdaptorAuthorizationUnitTestCase.class"/>
      <include name="**/test/perf/test/SecurePerfStressTestCase.class"/>
      <include name="**/test/timer/test/SecureTimerUnitTestCase.class"/>
      <include name="**/test/security/test/client/*UnitTestCase.class"/>
      <include name="**/test/profileservice/testsecure/*UnitTestCase.class"/>
   </patternset>
   <patternset id="security.excludes">
      <exclude name="**/test/naming/test/Security*"/>
      <exclude name="**/test/security/test/*UnitTestCase.class"/>
      <exclude name="**/test/security/test/authorization/*UnitTestCase.class"/>
      <exclude name="**/test/jca/test/SecurityContextUnitTestCase.class"/>
      <exclude name="**/test/jmx/test/Secure*"/>
      <include name="**/test/jmx/test/RMIAdaptorAuthorizationUnitTestCase.class"/>
      <exclude name="**/test/jrmp/test/DynLoadingUnitTestCase.class"/>
      <exclude name="**/test/jrmp/test/DynLoadingFromSARUnitTestCase.class"/>
      <exclude name="**/test/jrmp/test/DynLoadingFromSARUnpackedUnitTestCase.class"/>
      <exclude name="**/test/perf/test/SecurePerfStressTestCase.class"/>
      <exclude name="**/test/timer/test/SecureTimerUnitTestCase.class"/>
      <exclude name="**/test/web/security/authorization/XACMLWeb*.class"/>
      <exclude name="**/test/security/test/client/*UnitTestCase.class"/>
      <exclude name="**/test/profileservice/testsecure/*UnitTestCase.class"/>
      <exclude name="**/test/passwordinjection/test/*UnitTestCase.class"/>
   </patternset>
   <!-- A patternset that requires jboss to run with a security manager -->
   <patternset id="securitymgr.includes">
      <include name="**/test/securitymgr/test/*TestCase.class"/>
   </patternset>
   <patternset id="securitymgr.excludes">
      <exclude name="**/test/securitymgr/test/*"/>
   </patternset>
	<!-- Patternset for the JSR-196 based unit tests -->
    <patternset id="security.jaspi.includes">
      <include name="**/test/security/container/auth/**/*TestCase.class"/>
      <include name="**/test/security/managers/**/*TestCase.class"/>
      <include name="org/jboss/test/web/security/authorization/*TestCase.class"/>
      <include name="org/jboss/test/web/test/JASPIFormAuthUnitTestCase.class"/>
   </patternset>
   <patternset id="stax.include">
      <include name="org/jboss/test/stax/**/*TestCase.class"/>
   </patternset>
   <!-- Tests needing non-clustered tomcat SSO -->
   <patternset id="tc-sso.includes">
      <include name="org/jboss/test/web/test/SingleSignOnUnitTestCase.class"/>
      <include name="org/jboss/test/web/test/WebProgrammaticLoginTestCase.class"/>
   </patternset>
   <patternset id="tc-sso.excludes">
      <exclude name="org/jboss/test/web/test/SingleSignOnUnitTestCase.class"/>
      <exclude name="org/jboss/test/web/test/WebProgrammaticLoginTestCase.class"/>
   </patternset>
   <!-- Tests needing clustered tomcat SSO -->
   <patternset id="tc-sso-clustered.includes">
      <include name="org/jboss/test/web/test/ClusteredSingleSignOnUnitTestCase.class"/>
   </patternset>
   <patternset id="tc-sso-clustered.excludes">
      <exclude name="org/jboss/test/web/test/ClusteredSingleSignOnUnitTestCase.class"/>
   </patternset>
   <!-- Tests needing tomcat federation -->
   <patternset id="tc-federation.includes">
      <include name="org/jboss/test/web/security/*TestCase.class"/>
      <include name="org/jboss/test/web/test/FormAuthUnitTestCase.class"/>
      <exclude name="org/jboss/test/web/security/GenericHeaderAuthUnitTestCase.class"/>
   </patternset>
   <!-- Tests needing tomcat SSL -->
   <patternset id="tc-ssl.includes">
      <include name="org/jboss/test/web/test/ssl/*TestCase.class"/>
   </patternset>
   <patternset id="tc-ssl.excludes">
      <exclude name="org/jboss/test/web/test/ssl/*"/>
   </patternset>
   <!-- Tests needing tomcat WebCtxLoader set via the UseJBossWebLoader setting -->
   <patternset id="tomcat.webctx.includes">
      <include name="org/jboss/test/web/test/WebCtxLoaderTestCase.class"/>
   	  <include name="org/jboss/test/web/test/VirtualHostTestCase.class"/>
   </patternset>
   <!-- ws-bpel integration tests -->
   <patternset id="jbpm-bpel.includes">
     <include name="org/jboss/test/bpel/**/*TestCase.class"/>
   </patternset>
   <patternset id="jbpm-bpel.excludes">
     <exclude name="org/jboss/test/bpel/**/*TestCase.class"/>
   </patternset>
  <!-- Classloader Leak Tests -->
  <patternset id="classloader-leak.includes">
    <include name="org/jboss/test/classloader/leak/test/*TestCase.class"/>
  </patternset>
  <patternset id="classloader-leak.excludes">
    <exclude name="org/jboss/test/classloader/leak/test/*TestCase.class"/>
  </patternset>
  <patternset id="profileservice.includes">
    <include name="org/jboss/test/profileservice/test/*TestCase.class"/>
  	<include name="org/jboss/test/profileservice/override/test/*TestCase.class"/>
    <!-- deployers + seam -->
  	<include name="org/jboss/test/deployers/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/client/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/ear/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/ejb/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/rar/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/sar/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/web/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/jbas2904/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/seam/test/*UnitTestCase.class"/>
  </patternset>
  <patternset id="profileservice.excludes">
    <exclude name="org/jboss/test/profileservice/test/*TestCase.class"/>
  	<exclude  name="org/jboss/test/profileservice/override/test/*TestCase.class"/>
    <!-- deployers + seam -->
  	<exclude name="org/jboss/test/deployers/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/client/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/ear/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/ejb/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/rar/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/sar/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/web/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/jbas2904/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/seam/test/*UnitTestCase.class"/>
  </patternset>
  <patternset id="profileservice.restart.includes">
    <!-- include target for persisted admin changes -->
    <include name="org/jboss/test/profileservice/override/restart/test/*TestCase.class"/>
  </patternset>
  <patternset id="profileservice.restart.excludes">
	<exclude name="org/jboss/test/profileservice/override/restart/test/*TestCase.class"/>
  </patternset>
  <patternset id="springdeployer.includes">
    <include name="org/jboss/test/spring/test/*TestCase.class"/>
  </patternset>
  <patternset id="springdeployer.excludes">
    <exclude name="org/jboss/test/spring/test/*TestCase.class"/>
  </patternset>

   <!-- Tests that are currently broken -->
   <patternset id="badtest.excludes">
      <exclude name="org/jboss/test/aop/test/RemotingUnitTestCase"/>
   	        
      <!-- Needs apache ? -->
      <exclude name="org/jboss/test/cluster/httpsessionreplication/**" />
      <exclude name="org/jboss/test/cache/test/local/ConcurrentTransactionalUnitTestCase.class" />
      <!-- JBAS-2026 -->
      <exclude name="org/jboss/test/jmx/test/JarInSarJSR77UnitTestCase.class"/>
      <!-- Tests invoking JBossCache via MBean interface, which is no longer supported -->
      <exclude name="org/jboss/test/cluster/defaultcfg/cache/test/*"/> 
      <!-- JBAS-4548 -->
      <exclude name="org/jboss/test/deployers/ear/test/EmbeddedDatasourceUnitTestCase.class"/>
     	<!-- Test of old farming implementation -->
      <exclude name="org/jboss/test/cluster/multicfg/test/ClusterFileTransferTestCase.class"/>
   	<!-- Unfinished test of clustered deployment via profile service -->
      <exclude name="org/jboss/test/cluster/defaultcfg/profileservice/test/ClusteredDeployUnitTestCase.class"/>
      <!-- JASPI needs revisiting -->
      <exclude name="org/jboss/test/web/test/JASPIFormAuthUnitTestCase.class"/>
   	<!-- New diagnostic test that has transient failures; needs further work -->
   	<exclude name="org/jboss/test/cluster/defaultcfg/simpleweb/test/ClusteredSessionMemoryLeakTestCase.class"/>
   	
   	<!-- Exclude some classloader leak tests on Sun VM only; they should run on JRockit, OpenJDK -->
   	<exclude name="org/jboss/test/classloader/leak/test/AopPreparedClassesClassloaderLeakUnitTestCase.class" if="sun-vm"/>
   	<exclude name="org/jboss/test/cluster/classloader/leak/test/*Field*TestCase.class" if="sun-vm"/>
   
      <!-- JBAS-6582, http://lists.jboss.org/pipermail/jboss-development/2008-December/013254.html -->
      <exclude name="org/jboss/test/ejb3/servlet/unit/ServletUnitTestCase.class"/>

   	  <!-- JBAS-6792 fix temporarily reverted -->
      <!--exclude name="org/jboss/test/cluster/defaultcfg/test/HAServiceUnitTestCase.class"/>
      <exclude name="org/jboss/test/cluster/defaultcfg/test/HASingletonUnitTestCase.class"/-->
   	
   	<!-- JBAS-6094, see http://www.jboss.org/index.html?module=bb&op=viewtopic&t=155647 -->
   	<exclude name="org/jboss/test/cluster/defaultcfg/test/ClusterPartitionManagedObjectsTestCase.class"/>
   </patternset>

   <patternset id="aop-with-classloader.excludes">
      <!-- Needs to be started either with the bootclasspath or -javaagent classloader hooks -->
      <exclude name="org/jboss/test/aop/test/Scoped*.class"/>
   </patternset>
   <patternset id="aop-with-classloader.includes">
      <include name="org/jboss/test/aop/test/Scoped*TestCase.class"/>
   </patternset>

   <!-- The union of the excludes -->
   <patternset id="all.excludes">
      <patternset refid="aop-with-classloader.excludes"/>
      <patternset refid="badtest.excludes"/>
      <patternset refid="classloader-leak.excludes"/>
      <patternset refid="bootstrap-dependencies.excludes"/>
      <patternset refid="cluster.excludes"/>
      <patternset refid="security.excludes"/>
      <patternset refid="securitymgr.excludes"/>
      <patternset refid="jacc.excludes"/>
      <patternset refid="tc-sso.excludes"/>
      <patternset refid="tc-sso-clustered.excludes"/>
      <patternset refid="tc-ssl.excludes"/>
      <patternset refid="iiop.excludes"/>
      <patternset refid="jbossxb.excludes"/>
      <patternset refid="deployment-service.excludes"/>
      <patternset refid="compatibility.excludes"/>
      <patternset refid="binding-manager.excludes"/>
      <patternset refid="profileservice.excludes"/>
      <patternset refid="profileservice.restart.excludes"/>
      <patternset refid="jbossmessaging.excludes"/>
      <patternset refid="springdeployer.excludes"/>
   </patternset>

   <!-- A target that allows for conditional dependency on the compilation and

    -->
   <target name="maybejars"
      unless="nojars">
      <antcall target="jars" inheritRefs="true"/>
   </target>

   <!-- The top level entry point for all tests that can be run against
   variations of the standard jboss dist. This does not include long
   running benchmark oriented tests.
   -->
   <target name="tests" description="Execute all non-benchmark tests."
      depends="maybejars">
      <record name="${basedir}/output/tests.log" append="no" action="start" loglevel="info"/>
      <property name="nojars" value="true"/>
      <antcall target="jboss-minimal-tests" />
      <antcall target="jboss-all-config-tests"/>
      <antcall target="tests-profileservice"/>
      <antcall target="tests-bootstrap-dependencies"/>
      <antcall target="tests-springdeployer"/>
<!--
      <antcall target="tests-security-manager"/>
-->
      <antcall target="tests-clustering-all-stacks"/>
      <antcall target="tomcat-ssl-tests"/>
      <antcall target="tomcat-sso-tests"/>
      <antcall target="tomcat-sso-clustered-tests"/>
      <antcall target="tomcat-webctx-tests"/>
      <antcall target="tomcat-federation-tests"/>
      <antcall target="tests-binding-manager"/>
      <antcall target="tests-jacc-security"/>
      <antcall target="tests-jacc-securitymgr"/>
      <antcall target="tests-jacc-security-allstarrole"/>
<!--
      <antcall target="tests-security-jaspi-unit"/>
-->
      <antcall target="tests-jbossmessaging"/>
      <antcall target="tests-jbossmessaging-cluster"/>
      <antcall target="tests-compatibility"/>
      <antcall target="tests-aop-scoped"/>
      <antcall target="jrmp-invoker-tests"/>
      <antcall target="pooled-invoker-tests"/>
      <antcall target="tests-clustered-profileservice"/>
      <antcall target="tests-web-profile"/>
      <antcall target="tests-jts" />
   	
      <!-- NOTE: Run the classloader leak tests last as they can be
                 disruptive to the overall run if there are failures. -->
      <antcall target="tests-classloader-leak"/>
      <antcall target="tests-clustered-classloader-leak"/>
   	
      <antcall target="tests-report"/>
      <!-- JBAS-5918 https://issues.apache.org/bugzilla/show_bug.cgi?id=41368 
      <record name="${basedir}/output/tests.log" action="stop"/>
      -->
      <condition property="servers.shutdown.failed">
         <and>
            <not><isset property="servers.shutdown.nocheck"/></not>
            <isfileselected file="output/tests.log">
               <or>
                  <contains text="Unable to shutdown server properly"/>
                  <not><contains text="[server:stop]"/></not>
               </or>
            </isfileselected>
         </and>
      </condition>
      <fail message="Some servers failed to shutdown cleanly."
         if="servers.shutdown.failed"/>
   </target>

   <target name="tests-stress" description="Execute all stress tests."
      depends="tests-standard-stress,
               tests-report">
   </target>

   <target name="jboss-minimal-tests"
      description="Validate the minimal config">
      <server:start name="minimal"/>
      <copy file="${build.lib}/shutdown.sar"
         todir="${jboss.dist}/server/minimal/deploy" />
      <echo message="Minimal server started, stopping"/>
      <sleep seconds="10"/>
      <delete file="${jboss.dist}/server/minimal/deploy/shutdown.sar" />
      <sleep seconds="7"/>
   </target>

   <target name="jboss-all-config-tests"
      description="The units tests which are run against the jboss all config" depends="init">
      <server:start name="all"/>
      <antcall target="tests-standard-unit"/>
      <antcall target="tests-client-unit"/>
      <antcall target="tests-security-basic-unit"/>
      <antcall target="tests-standard-stress"/>
      <antcall target="tests-jbossmx-compliance"/>
      <antcall target="tests-jbossmx-implementation"/>
      <antcall target="tests-jbossmx-performance"/>
      <antcall target="tests-iiop"/>
      <antcall target="tests-scout-jaxr"/>
      <antcall target="tests-webservice" />
      <antcall target="tests-aspects"/>
      <server:stop name="all"/>
   </target>

   <target name="smoke-tests"
      description="A basic set of units tests which are run against the jboss all config" depends="init">
      <server:start name="all"/>
      <antcall target="smoke-tests-raw"/>
      <server:stop name="all"/>
   </target>

   <target name="tests-profileservice" description="Tests with the full featured profile service">
      <create-profileservice-config baseconf="default" conf="profileservice"/>
      <server:start name="profileservice"/>
      <run-junit
         junit.patternset="profileservice.includes"
         junit.configuration="profileservice"
      />
      <server:stop name="profileservice"/>
	  <!-- test profileservice persistence, after restarting AS -->       	
      <server:start name="profileservice"/>
      <run-junit
         junit.patternset="profileservice.restart.includes"
         junit.configuration="profileservice"
      />
      <server:stop name="profileservice"/>
   </target>
   <target name="profileservice-config" description="Create the full featured profile service config">
      <create-profileservice-config baseconf="default" conf="profileservice"/>
   </target>
	
   <target name="tests-web-profile" description="Tests with the web profile">
      <server:start name="web"/>
      <antcall target="run-web-profile-unit"/>
      <server:stop name="web"/>
   </target>
   
   <target name="tests-springdeployer" description="Tests with the full featured spring deployer">
      <create-springdeployer-config baseconf="default" conf="springdeployer"/>
      <server:start name="springdeployer"/>
      <run-junit junit.patternset="springdeployer.includes" junit.configuration="springdeployer"/>
      <server:stop name="springdeployer"/>
   </target>
   <target name="springdeployer-config" description="Create the full featured spring deployer config">
      <create-springdeployer-config baseconf="default" conf="springdeployer"/>
   </target>

   <!-- Tests of tomcat needing a ssl connector
   -->
   <target name="tomcat-ssl-tests"
      description="Tomcat tests requiring an SSL connector">
      <!-- Create the ssl enabled tomcat config -->
      <create-config baseconf="default" newconf="tomcat-ssl">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/jbossweb.sar/**"/>
            <include name="deploy/ROOT.war/**"/>
            <include name="deploy/security/**"/>
            <include name="deploy/jca*"/>
            <include name="deploy/legacy*"/>
            <include name="lib/**"/>
            <include name="deploy/jmx-invoker-service.xml"/>
            <include name="deploy/transaction-jboss-beans.xml"/>
         </patternset>
      </create-config>

      <server:start name="tomcat-ssl"/>

      <!-- Specify the JSSE properties -->
      <property name="javax.net.ssl.keyStore"
         value="${build.resources}/test-configs/tomcat-ssl/conf/client.keystore"/>
      <property name="javax.net.ssl.keyStorePassword" value="unit-tests-client"/>
      <property name="javax.net.ssl.trustStore"
         value="${build.resources}/test-configs/tomcat-ssl/conf/client.keystore"/>
      <property name="javax.net.ssl.trustStorePassword" value="unit-tests-client"/>

      <propertyset id="tomcat-ssl-tests-props">
         <propertyref prefix="javax.net.ssl"/>
      </propertyset>
      <run-junit junit.patternset="tc-ssl.includes"
        junit.configuration="tomcat-ssl-tests"
	junit.syspropertyset="tomcat-ssl-tests-props" />

      <server:stop name="tomcat-ssl"/>
   </target>

   <!-- Tests of tomcat requiring SSO configured
   -->
   <target name="tomcat-sso-tests"
      description="Tomcat tests requiring SSO configured">
      <!-- Create the sso enabled tomcat config starting with the default config -->
      <create-config baseconf="default" newconf="tomcat-sso">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>
      <server:start name="tomcat-sso"/>
      <run-junit junit.patternset="tc-sso.includes"
	junit.configuration="tomcat-sso" />
      <server:stop name="tomcat-sso"/>
   </target>

   <target name="tomcat-sso-clustered-tests"
     description="Tomcat tests requiring clustered SSO configured">
    <!-- Create the sso enabled tomcat config starting with the all config -->
    <create-cluster-sso-node newconf="tomcat-sso-cluster0"/>
    <create-cluster-sso-node newconf="tomcat-sso-cluster1"/>
  
    <echo message="Modifying the node0 and node1 Tomcat configuration for REPL_SYNC/UseJK"/>
    <http-cluster-node-config-change conf="tomcat-sso-cluster0"/>
    <http-cluster-node-config-change conf="tomcat-sso-cluster1"/>

    <server:start name="tomcat-sso-cluster0"/>
    <server:start name="tomcat-sso-cluster1"/>

    <antcall target="tests-clustering-unit">
      <param name="cluster.includes.refid" value="tc-sso-clustered.includes"/>
      <param name="jboss-junit-configuration" value="tomcat-sso-cluster"/>
    </antcall>

    <server:stop name="tomcat-sso-cluster0"/>
    <server:stop name="tomcat-sso-cluster1"/>

    <!-- BuddyReplication enabled tests are eliminated as that's not a valid usage -->
   </target>

	 <!-- Tests that require the attribute "UseJBossWebLoader" set to true -->
   <target name="tomcat-webctx-tests"
       description="Tomcat tests requiring classloader set to the web loader">
       <create-config baseconf="default" newconf="tomcat-webctx"
         newconf-src="tomcat-webctx">
        <patternset>
           <include name="conf/**"/>
           <include name="deployers/**"/>
           <include name="deploy/**"/>
           <include name="lib/**"/>           
         </patternset>
      </create-config>

       <server:start name="tomcat-webctx"/>
       <run-junit junit.patternset="tomcat.webctx.includes"
	junit.configuration="tomcat-webctx"  />
       <server:stop name="tomcat-webctx"/>
    </target>

   <!-- Tests of tomcat requiring Federation configured
   -->
   <target name="tomcat-federation-tests"
      description="Tomcat tests requiring Federation configured">
      <!-- Create the federation enabled tomcat config starting with the default config -->
      <create-config baseconf="default" newconf="tomcat-federation">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
            <!-- Previous broken and fragile detailed listing of deploy content
            <include name="deploy/jbossweb.sar/**"/>
            <include name="deploy/ROOT.war/**"/>
            <include name="deploy/jmx-console.war/**"/>
            <include name="deploy/jmx-invoker-service.xml"/>
            <include name="deploy/hsqldb-ds.xml"/>
            <include name="deploy/jca-jboss-beans.xml"/>
            <include name="deploy/jboss-local-jdbc.rar"/>
            <include name="deploy/jboss-jdbc-metadata.sar"/>
            <include name="deploy/security*"/>
            -->
         </patternset>
      </create-config>
      <copy file="${source.resources}/web/federation/authext/war-deployers-jboss-beans.xml" overwrite="true" todir="${jboss.dist}/server/tomcat-federation/deployers/jbossweb.deployer/META-INF" />
      <copy file="${build.lib}/header-auth.jar" overwrite="true" todir="${jboss.dist}/server/tomcat-federation/deploy/jbossweb.sar" />
      <server:start name="tomcat-federation"/>
      <run-junit junit.patternset="tc-federation.includes"
	junit.configuration="tomcat-federation" />
      <server:stop name="tomcat-federation"/>
   </target>

   <target name="tests-binding-manager"
     description="Test for clean startup with service binding manager">
   	
     <create-cluster-node conf="binding-manager1"/>
     <create-cluster-node conf="binding-manager2"/>
     <server:start name="binding-manager1"/>
     <server:start name="binding-manager2"/>

     <run-junit junit.patternset="binding-manager.includes"
	            junit.configuration="binding-manager" />

     <server:stop name="binding-manager1"/>
     <server:stop name="binding-manager2"/>
   </target>

   <!--
     | Tests ejb calls using the jrmp invoker
   -->
   <target name="jrmp-invoker-tests"
      description="EJB tests using the jrmp invoker">
      <!-- Create the jrmp invoker enabled config -->
      <create-config baseconf="default" newconf="jrmp-invoker">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>
      <server:start name="jrmp-invoker"/>

      <run-junit junit.patternset="jrmp-invoker.includes"
         junit.configuration="JRMP-Invoker" />

      <server:stop name="jrmp-invoker"/>
   </target>

   <!--
     | Tests ejb calls using the pooled invoker
   -->
   <target name="pooled-invoker-tests"
      description="EJB tests using the jrmp invoker">
      <!-- Create the jrmp invoker enabled config -->
      <create-config baseconf="default" newconf="pooled-invoker">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>
      <server:start name="pooled-invoker"/>

      <!-- This is pooled but we use the same tests as jrmp -->
      <run-junit junit.patternset="jrmp-invoker.includes"
         junit.configuration="Pooled-Invoker" />

      <server:stop name="pooled-invoker"/>
   </target>

   <!--
     | Tests DeploymentService
   -->
   <target name="deployment-service-tests"
      description="Tests targeting the deployment service">
      <!-- Create clean configuration -->
      <delete dir="${jboss.dist}/server/deployment-service" />
      <create-config baseconf="default" newconf="deployment-service">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
            <!-- Previous broken and fragile detailed listing of deploy content
            <include name="deploy/jbossweb.sar/**"/>
            <include name="deploy/ROOT.war/**"/>
            <include name="deploy/jmx-console.war/**"/>
            <include name="deploy/messaging/**"/>
            <include name="deploy/jca-jboss-beans.xml"/>
            <include name="deploy/jboss-local-jdbc.rar"/>
            <include name="deploy/jmx-invoker-service.xml"/>
            <include name="deploy/hsqldb-ds.xml"/>
            -->
         </patternset>
      </create-config>
      <!-- overlay the deployment-service stuff -->
      <copy todir="${jboss.dist}/server/deployment-service/conf">
         <fileset dir="${jboss.dist}/docs/examples/varia/deployment-service">
            <include name="templates/**"/>
         </fileset>
      </copy>
      <copy todir="${jboss.dist}/server/deployment-service/deploy">
         <fileset dir="${jboss.dist}/docs/examples/varia/deployment-service">
            <include name="deployment-service.sar"/>
         </fileset>
      </copy>
      <server:start name="deployment-service"/>
      <antcall target="deployment-service-unit-tests">
         <param name="jboss-junit-configuration" value="DeploymentService"/>
      </antcall>
      <server:stop name="deployment-service"/>
   </target>

   <target name="deployment-service-unit-tests">
     <run-junit junit.patternset="deployment-service.includes"
        junit.configuration="deployment-service"/>
   </target>

  <!--
     A minimal set of tests
     
     This should have a wide variety of basic tests,
     that don't take very long to run.
  -->
  <target name="smoke-tests-raw" depends="init">
      <echo><![CDATA[
   junit.timeout:              ${junit.timeout}
   jbosstest.iterationcount:   ${jbosstest.iterationcount}
   jbosstest.threadcount:      ${jbosstest.threadcount}
   jbosstest.beancount:        ${jbosstest.beancount}
         ]]></echo>
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>

         <!-- Used for JGroups -->
         <jvmarg value="-Dbind.address=${node0}"/>
         <sysproperty key="jboss.dist" value="${jboss.dist}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
      	 <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="jbosstest.useJBM" value="true"/>

      	 <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>
         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <formatter type="xml" usefile="${junit.formatter.usefile}"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/aop/test/AOPUnitTestCase.class"/>
               <include name="org/jboss/test/classloader/test/ScopingUnitTestCase.class"/>
               <include name="org/jboss/test/cts/test/*UnitTestCase.class"/>
               <exclude name="org/jboss/test/cts/test/StatefulSessionLocalUnitTestCase.class"/>
               <exclude name="org/jboss/test/cts/test/StatefulSessionUnitTestCase.class"/>
               <exclude name="org/jboss/test/cts/test/LongWaitStatefulSessionUnitTestCase.class"/>
               <include name="org/jboss/test/ejb3/test/SimpleSessionUnitTestCase.class"/>
               <include name="org/jboss/test/jbossmessaging/test/JBossMessagingJoramUnitTestCase.class"/>
               <include name="org/jboss/test/jca/test/BaseConnectionManagerUnitTestCase.class"/>
               <include name="org/jboss/test/jca/test/PoolingUnitTestCase.class"/>
               <include name="org/jboss/test/jca/test/XADSUnitTestCase.class"/>
               <include name="org/jboss/test/jmsra/test/*UnitTestCase.class"/>
               <include name="org/jboss/test/naming/test/SimpleUnitTestCase.class"/>
               <include name="org/jboss/test/tm/test/TransactionManagerUnitTestCase.class"/>
               <include name="org/jboss/test/web/test/WebIntegrationUnitTestCase.class"/>
               <include name="org/jboss/test/xml/DDValidatorUnitTestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

  <!--
     Web Profile Tests
  -->
  <target name="run-web-profile-unit" depends="init">
      <echo><![CDATA[
   junit.timeout:              ${junit.timeout}
   jbosstest.iterationcount:   ${jbosstest.iterationcount}
   jbosstest.threadcount:      ${jbosstest.threadcount}
   jbosstest.beancount:        ${jbosstest.beancount}
         ]]></echo>
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>

         <!-- Used for JGroups -->
         <jvmarg value="-Dbind.address=${node0}"/>
         <sysproperty key="jboss.dist" value="${jboss.dist}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="java.naming.factory.initial" value="org.jboss.naming.HttpNamingContextFactory"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.http.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="jbosstest.useJBM" value="true"/>

      	 <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>
         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <formatter type="xml" usefile="${junit.formatter.usefile}" extension="-web-profile.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/jpa/test/WebClassesJPAUnitTestCase.class"/>
               <include name="org/jboss/test/jpa/test/WebLibsJPAUnitTestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | Standard tests that should run successfully against a default JBoss
      | server distribution build.
    -->

  <target name="tests-standard-unit">
      <echo><![CDATA[
   junit.timeout:              ${junit.timeout}
   jbosstest.iterationcount:   ${jbosstest.iterationcount}
   jbosstest.threadcount:      ${jbosstest.threadcount}
   jbosstest.beancount:        ${jbosstest.beancount}
         ]]></echo>
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <!-- Used for JGroups -->
         <jvmarg value="-Dbind.address=${node0}"/>
         <sysproperty key="jboss.dist" value="${jboss.dist}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
      	 <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="jbosstest.useJBM" value="true"/>

      	 <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>
         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <formatter type="xml" usefile="${junit.formatter.usefile}"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="**/*UnitTestCase.class"/>
               <patternset refid="all.excludes"/>
               <exclude name="**/test/xa/test/XAUnitTestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <target name="tests-standard-stress">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
	 <sysproperty key="jboss-junit-configuration" value="tests-standard-stress"/>
	 <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
		  usefile="${junit.formatter.usefile}"
		  extension="-tests-standard-stress.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="**/*StressTestCase.class"/>
               <patternset refid="all.excludes"/>
            </fileset>
         </batchtest>
      </junit>
   </target>


   <!--
      | Tests that need to be run by loading the testcase code from a client
      | jar rather than the build.classes.dir. Typically these tests need to
      | control how classes are loaded.
    -->
   <target name="tests-client-unit">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="jbosstest.secure" value="true"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <jvmarg value="-Djava.security.manager"/>
         <sysproperty key="java.security.policy"
            value="${build.resources}/security/tst.policy"/>
         <sysproperty key="java.security.auth.login.config"
            value="${build.resources}/security/auth.conf"/>

         <classpath>
            <pathelement path="${build.lib}/jrmp-dl-client.jar"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-client-unit"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-client-unit.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/jrmp/test/DynLoadingUnitTestCase.class"/>
               <include name="org/jboss/test/jrmp/test/DynLoadingFromSARUnitTestCase.class"/>
               <include name="org/jboss/test/jrmp/test/DynLoadingFromSARUnpackedUnitTestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | Standard security tests that should run successfully against a default
      | JBoss server distribution build.
    -->
   <target name="tests-security-basic-unit">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <property name="jbosstest.secure" value="true"/>
      <property name="java.security.auth.login.config"
        value="${build.resources}/security/auth.conf"/>
      <propertyset id="security-tests-props">
         <propertyref prefix="java.security.auth"/>
      </propertyset>
      <run-junit junit.patternset="security.includes"
         junit.syspropertyset="security-tests-props"
         junit.configuration="tests-security-basic-unit" />
   </target>

   <!-- Tests of Java2 permissions. The JBoss server must be running with
    a security manager for this test -->
   <target name="tests-security-manager"
      description="Tests run against a jboss server with a security manager">

      <create-config baseconf="default" newconf="secmgr">
        <patternset>
           <include name="conf/**"/>
           <include name="deployers/**"/>
           <include name="deploy/**"/>
           <include name="lib/**"/>
        </patternset>
      </create-config>


      <echo message="Starting secmgr with policy ${build.resources}/securitymgr/server.policy" />
      <echo message="jboss.home.dir=${jboss.dist}" />
      <echo message="jboss.server.home.dir=${jboss.dist}${/}server${/}secmgr" />
      <echo message="java.naming.provider.url=${node0.jndi.url}" />
      <echo message="jbosstest.server.host=${node0}" />

      <server:start name="securitymgr"/>

      <junit dir="${module.output}"
         printsummary="true"
         haltonerror="false"
         haltonfailure="false"
         fork="true"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>

         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="jboss.home" file="${project.root}"/>
         <sysproperty key="jboss.thirdparty.dir" file="${project.root}/thirdparty"/>
         <sysproperty key="jboss.tools.dir" file="${project.root}/tools"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="jbosstest.secure" value="true"/>
         <sysproperty key="java.security.auth.login.config"
            value="${build.resources}/security/auth.conf"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>

         <classpath>
            <pathelement location="${build.resources}"/>
            <pathelement location="${build.classes}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <sysproperty key="jboss-junit-configuration" value="tests-security-manager"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-security-manager.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="false"
            haltonfailure="false"
            fork="true">

            <fileset dir="${build.classes}">
               <exclude name="org/jboss/test/securitymgr/test/PolicyUnitTestCase.class"/>
               <patternset refid="securitymgr.includes"/>
            </fileset>
         </batchtest>
      </junit>
      <echo>Waiting for server to shutdown...</echo>
      <server:stop name="securitymgr"/>
   </target>

   <!-- Tests of the JACC security implementation -->
   <target name="tests-jacc-security"
      description="Tests run against a jboss server with JACC configured">
      <!-- Create the ssl enabled tomcat config -->
      <create-config baseconf="default" newconf="jacc">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
            <!-- Previous broken and fragile detailed listing of deploy content
            <include name="deploy/jbossweb.sar/**"/>
            <include name="deploy/ROOT.war/**"/>
            <include name="deploy/ejb2-timer-service.xml"/>
            <include name="deploy/hsqldb-ds.xml"/>
            <include name="deploy/jbossws.sar/**"/>
            <include name="deploy/client-deployer-service.xml"/>
            <include name="deploy/jms-ds.xml"/>
            <include name="deploy/jms-ra.rar"/>
            <include name="deploy/jmx-invoker-service.xml"/>
            <include name="deploy/jmx-console.war/**"/>
            <include name="deploy/jca-jboss-beans.xml"/>
            <include name="deploy/jboss-local-jdbc.rar"/>
            <include name="deploy/mail-service.xml"/>
            <include name="deploy/messaging/**"/>
            <include name="deploy/ejb3-interceptors-aop.xml"/>
            <include name="deploy/security-beans.xml"/>
            -->
         </patternset>
      </create-config>
      <!-- Copy the test-destinations-service.xml to the all config.
          Additionally this file should be there in the jacc config
      <copy file="${build.resources}/messaging/test-destinations-full-service.xml"
      todir="${jboss.dist}/server/jacc/deploy" />
      -->

      <server:start name="jacc"/>

      <!-- ROOT.war is needed for confirmation that the server has started. But there is a test case "WebIntegrationUnitTestCase" that tries to replace the root context war. So delete the ROOT.war 
      <delete dir="${jboss.dist}/server/jacc/deploy/ROOT.war" />
     -->

      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>

     <property name="jbosstest.secure" value="true"/>
     <property name="jboss.security.jacc" value="true" />
     <property name="java.security.auth.login.config"
            value="${build.resources}/security/auth.conf"/>
     <propertyset id="jacc-tests-props">
        <propertyref prefix="java.security.auth"/>
		<propertyref prefix="jboss.security"/>
     </propertyset>

     <run-junit junit.patternset="jacc.includes"
        junit.configuration="JACC"
	junit.syspropertyset="jacc-tests-props" />

      <server:stop name="jacc"/>
   </target>

   <target name="tests-jacc-securitymgr"
     description="Tests run against a jboss server with JACC configured + security manager">
      <!-- Create the security manager enabled jacc -->
      <create-config baseconf="default" newconf="jacc-securitymgr" newconf-src="jacc">
       <patternset>
          <include name="conf/**"/>
          <include name="deployers/**"/>
          <include name="deploy/**"/>
          <include name="lib/**"/>
          <!-- Previous broken and fragile detailed listing of deploy content
          <include name="deploy/jbossweb.sar/**"/>
          <include name="deploy/ROOT.war/**"/>
          <include name="deploy/hsqldb-ds.xml"/>
          <include name="deploy/jbossws.sar/**"/>
          <include name="deploy/client-deployer-service.xml"/>
          <include name="deploy/jmx-invoker-service.xml"/>
          <include name="deploy/jmx-console.war/**"/>
          <include name="deploy/jca-jboss-beans.xml"/>
          <include name="deploy/jboss-local-jdbc.rar"/>
          <include name="deploy/mail-service.xml"/>
          <include name="deploy/messaging/**"/>
          <include name="deploy/ejb3-interceptors-aop.xml"/>
          -->
       </patternset>
     </create-config>
     <server:start name="jacc-securitymgr"/>

     <mkdir dir="${build.reports}"/>
     <mkdir dir="${build.testlog}"/>


      <property name="jbosstest.secure" value="true"/>
      <property name="jboss.security.jacc" value="true" />
      <property name="java.security.auth.login.config"
        value="${build.resources}/security/auth.conf"/>
      <propertyset id="jacc-tests-props">
         <propertyref prefix="java.security.auth"/>
      </propertyset>

      <propertyset id="jacc-tests-props">
         <propertyref prefix="java.security.auth"/>
		 <propertyref prefix="jboss.security"/>
      </propertyset>

      <run-junit junit.patternset="jacc.includes"
         junit.configuration="JACC+SecurityMgr"
         junit.syspropertyset="jacc-tests-props" />

     <server:stop name="jacc-securitymgr"/>
   </target>

   <target name="tests-jacc-security-allstarrole"
     description="Tests run against a jboss server with JACC configured + security manager">
      <!-- Create the security manager enabled jacc -->
      <create-config baseconf="default" newconf="jacc-security-allstarrole" newconf-src="jacc">
       <patternset>
          <include name="conf/**"/>
          <include name="deployers/**"/>
          <include name="deploy/**"/>
          <include name="lib/**"/>
       </patternset>
     </create-config>

    <!-- Use the test policy provider -->
    <copy todir="${jboss.dist}/server/jacc-security-allstarrole/deployers" file="${build.resources}/test-configs/jacc-security-allstarrole/deployers/jacc-jboss-beans.xml" overwrite="true"/>
     <!-- Copy the jacc allStarRolePolicyProvider jar -->
    <copy todir="${jboss.dist}/server/jacc-security-allstarrole/lib" file="${build.lib}/jacc-allStarRolePolicyProvider.jar"/>

     <server:start name="jacc-security-allstarrole"/>

     <mkdir dir="${build.reports}"/>
     <mkdir dir="${build.testlog}"/>

      <property name="jbosstest.secure" value="true"/>
      <property name="jboss.security.jacc" value="true" />
      <property name="java.security.auth.login.config"
        value="${build.resources}/security/auth.conf"/>
      <propertyset id="jacc-tests-props">
      <propertyref prefix="java.security.auth"/>
      </propertyset>

      <propertyset id="jacc-tests-props">
      <propertyref prefix="java.security.auth"/>
      <propertyref prefix="jboss.security"/>
      </propertyset>

      <run-junit junit.patternset="jacc.allstarrole.includes"
         junit.configuration="JACC+allstarrole"
         junit.syspropertyset="jacc-tests-props" />

     <server:stop name="jacc-security-allstarrole"/>
   </target>

   <!--
      | JSR196 Based Unit Tests
    -->
   <target name="tests-security-jaspi-unit"
     description="Tests run against a jboss server with jaspi configured">
      <create-config baseconf="default" newconf="jaspi">
	   <patternset>
          <include name="conf/**"/>
          <include name="deployers/**"/>
          <include name="deploy/**"/>
          <include name="lib/**"/>
          <!-- Previous broken and fragile detailed listing of deploy content
          <include name="deploy/jbossweb.sar/**"/>
          <include name="deploy/ROOT.war/**"/>
          <include name="deploy/hsqldb-ds.xml"/>
          <include name="deploy/client-deployer-service.xml"/>
          <include name="deploy/jmx-invoker-service.xml"/>
          <include name="deploy/jmx-console.war/**"/>
          <include name="deploy/jca-jboss-beans.xml"/>
          <include name="deploy/jboss-local-jdbc.rar"/>
          <include name="deploy/mail-service.xml"/>
	      <include name="deploy/messaging/**"/>
          <include name="deploy/ejb3-interceptors-aop.xml"/>
          -->
       </patternset>
     </create-config>
      <server:start name="jaspi"/>

     <mkdir dir="${build.reports}"/>
     <mkdir dir="${build.testlog}"/>


      <property name="jbosstest.secure" value="true"/>
      <property name="java.security.auth.login.config"
        value="${build.resources}/security/auth.conf"/>
      <propertyset id="jacc-tests-props">
         <propertyref prefix="java.security.auth"/>
      </propertyset>

      <propertyset id="jacc-tests-props">
         <propertyref prefix="java.security.auth"/>
		 <propertyref prefix="jboss.security"/>
      </propertyset>

      <run-junit junit.patternset="security.jaspi.includes" junit.configuration="tests-security-jaspi"/>

     <server:stop name="jaspi"/>
   </target>

<!-- Ldap Tests-->
   <target name="tests-ldap"
      description="Tests run against a jboss server with opends configured">
      <create-config baseconf="default" newconf="opends">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
            <!-- Previous broken and fragile detailed listing of deploy content
            <include name="deploy/jbossweb.sar/**"/>
            <include name="deploy/ROOT.war/**"/>
            <include name="deploy/hsqldb-ds.xml"/>
            <include name="deploy/client-deployer-service.xml"/>
            <include name="deploy/jmx-invoker-service.xml"/>
            <include name="deploy/jmx-console.war/**"/>
            <include name="deploy/jca-jboss-beans.xml"/>
            <include name="deploy/jboss-local-jdbc.rar"/>
            <include name="deploy/ejb3-interceptors-aop.xml"/>
            <include name="deploy/properties**"/>
            -->
         </patternset>
      </create-config>

      <copy file="${build.lib}/opends.sar"
        todir="${jboss.dist}/server/opends/deploy" />
      <server:start name="opends"/>

      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>

     <property name="jbosstest.secure" value="true"/>
     <property name="java.security.auth.login.config"
            value="${build.resources}/security/auth.conf"/>
     <property name="jboss.security.ldap.ctxfactory"
            value="com.sun.jndi.ldap.LdapCtxFactory"/>

     <propertyset id="opends-tests-props">
        <propertyref prefix="java.security.auth"/>
	<propertyref prefix="jboss.security"/>
     </propertyset>
     <run-junit junit.patternset="ldap.includes"
        junit.configuration="opends"
	junit.syspropertyset="opends-tests-props" />
      <server:stop name="opends"/>
   </target>


   <target name="tests-standalone-aop-unit">
      <!--
          <antcall target="tests-treecacheaop-unit" inheritRefs="true"/>
      -->
      <antcall target="tests-treecacheaopc-unit" inheritRefs="true"/>
      <antcall target="tests-baseaop-unit" inheritRefs="true"/>
   </target>

  <target name="tests-compatibility"
    description="Checks compatibility on SerialUUID" depends="init">
    <junit dir="${module.output}"
      printsummary="${junit.printsummary}"
      haltonerror="${junit.haltonerror}"
      haltonfailure="${junit.haltonfailure}"
      fork="true"
      timeout="300000"
      jvm="${junit.jvm}">

      <jvmarg line="${junit.jvm.options}"/>
      <jvmarg value="-XX:MaxPermSize=512m"/>
      <jvmarg value="-Xms256m"/>
      <jvmarg value="-Xmx512m"/>
      <sysproperty key="jboss.dist" file="${jboss.dist}"/>
      <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
      <sysproperty key="build.testlog" value="${build.testlog}"/>
      <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
      <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>
      <!-- Pass along any jbosstest.* system properties -->
      <syspropertyset>
        <propertyref prefix="jbosstest."/>
      </syspropertyset>

      <!-- This runs with a minimal classpath as the jboss classes need to
         be loaded in a seperate class loader.
      -->
      <classpath>
        <pathelement location="${build.classes}"/>
        <pathelement location="${build.resources}"/>
        <path refid="jboss.test.classpath"/>
        <path refid="jboss.varia.classpath"/>
      </classpath>

      <!--formatter type="xml" usefile="${junit.formatter.usefile}"/-->
      <sysproperty key="jboss-junit-configuration" value="tests-compatibility"/>
      <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                 usefile="${junit.formatter.usefile}"
                 extension="-tests-compatibility.xml"/>

      <batchtest todir="${build.reports}"
        haltonerror="${junit.batchtest.haltonerror}"
        haltonfailure="${junit.batchtest.haltonfailure}"
        fork="${junit.batchtest.fork}">

        <fileset dir="${build.classes}">
          <patternset refid="compatibility.includes"/>
        </fileset>
      </batchtest>
    </junit>
  </target>


   <target name="tests-treecacheaop-unit" depends="init">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg value="-Djava.system.class.loader=org.jboss.aop.standalone.SystemClassLoader"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="jboss.aop.path" file="${source.resources}/cache/standalone/META-INF/jboss-aop.xml"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}/cache/standalone"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/-->
         <sysproperty key="jboss-junit-configuration" value="tests-treecacheaop-unit"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-treecacheaop-unit.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/cache/test/standAloneAop/*AopTest.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <target name="tests-treecacheaopc-unit" depends="init">
      <!-- pre-compile the aop classes -->
      <taskdef name="aopc" classname="org.jboss.aop.ant.AopC" classpathref="jboss.aop.classpath"/>
      <path id="aop.task.classpath">
         <path refid="javassist.classpath"/>
         <path refid="trove.classpath"/>
         <path refid="jboss.aop.classpath"/>
      <path refid="jboss.common.core.classpath"/>
      <path refid="jboss.common.logging.spi.classpath"/>
      <path refid="jboss.common.logging.log4j.classpath"/>
      <path refid="jboss.common.logging.jdk.classpath"/>
      </path>

      <aopc compilerclasspathref="aop.task.classpath">
         <classpath refid="thirdparty.classpath"/>
         <classpath path="${build.classes}"/>
         <src path="${build.classes}"/>
         <include name="org/jboss/test/cache/test/standAloneAop/**"/>
         <aoppath path="${source.resources}/cache/standalone/META-INF/jboss-aop.xml"/>
      </aopc>

      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="jboss.aop.path" file="${source.resources}/cache/standalone/META-INF/jboss-aop.xml"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}/cache/standalone"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-treecacheaopc-unit"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-treecacheaopc-unit.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/cache/test/standAloneAop/*AopTest.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>


   <target name="tests-baseaop-unit" depends="init">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <sysproperty key="java.system.class.loader" value="org.jboss.aop.standalone.SystemClassLoader"/>
         <sysproperty key="jboss.aop.path" file="${source.resources}/aop/META-INF/jboss-aop.xml"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <classpath>
            <pathelement location="${build.classes}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-baseaop-unit"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-baseaop-unit.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/aop/nonjunit/StandaloneTest.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | JBossMX implementation tests that should run correctly.
    -->
   <target name="tests-jbossmx-implementation">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>

         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-jbossmx-implementation"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-jbossmx-implementation.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="**/jbossmx/implementation/**/*TestCase.class"/>
               <!-- Ignore the abstract class -->
               <exclude name="org/jboss/test/jbossmx/implementation/TestCase.class"/>
               <exclude name="org/jboss/test/jmx/test/SecureJMXInvokerUnitTestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | JBossMX performance tests that should run correctly.
    -->
   <target name="tests-jbossmx-performance">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>

         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-jbossmx-performance"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-jbossmx-performance.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="**/jbossmx/performance/**/*TestCase.class"/>
               <!-- Ignore the abstract class -->
               <exclude name="org/jboss/test/jbossmx/performance/TestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | JBossMX compliance tests that should run correctly.
    -->
   <target name="tests-jbossmx-compliance">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>

         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-jbossmx-compliance"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-jbossmx-compliance.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="**/jbossmx/compliance/**/*TestCase.class"/>
               <!-- Ignore the abstract class -->
               <exclude name="org/jboss/test/jbossmx/compliance/TestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | IIOP test cases that should run successfully
    -->
   <target name="tests-iiop">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg value="-Dorg.omg.CORBA.ORBClass=org.jacorb.orb.ORB"/>
         <jvmarg value="-Dorg.omg.CORBA.ORBSingletonClass=org.jacorb.orb.ORBSingleton"/>
         <jvmarg value="-Djacorb.orb.print_version=off"/>
         <jvmarg value="-Djacorb.log.default.verbosity=0"/>
         <jvmarg value="-Djacorb.interop.strict_check_on_tc_creation=off"/>
         <jvmarg value="-Djacorb.log.loggerFactory=org.jboss.util.Log4jLoggerFactory"/>
         <jvmarg value="-Djacorb.security.ssl.client.supported_options=0"/>
         <jvmarg value="-Djacorb.security.ssl.client.required_options=0"/>
         <jvmarg value="-DORBInitRef.NameService=corbaloc::${node0}:3528/JBoss/Naming/root"/>
         <jvmarg value="-Dorg.omg.PortableInterceptor.ORBInitializerClass.org.jboss.tm.iiop.TxClientInterceptorInitializer"/>
         <jvmarg value="-Djava.security.manager"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="java.security.policy" value="${build.resources}/iiop/client.policy"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
            <path refid="jboss.iiop.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-iiop"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-iiop.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <patternset refid="iiop.includes"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

  <!-- Test the XML binding framework -->
  <target name="tests-xml-unit">
    <mkdir dir="${build.reports}"/>
    <mkdir dir="${build.testlog}"/>
    <junit dir="${module.output}"
      printsummary="${junit.printsummary}"
      haltonerror="${junit.haltonerror}"
      haltonfailure="${junit.haltonfailure}"
      fork="${junit.fork}"
      timeout="${junit.timeout}"
      jvm="${junit.jvm}">

      <jvmarg line="${junit.jvm.options}"/>
      <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
      <sysproperty key="build.testlog" value="${build.testlog}"/>
      <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

      <classpath>
        <pathelement location="${build.classes}"/>
        <pathelement location="${build.resources}"/>
        <path refid="tests.classpath"/>
      </classpath>

      <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
      <sysproperty key="jboss-junit-configuration" value="tests-xml-unit"/>
      <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                 usefile="${junit.formatter.usefile}"
                 extension="-tests-xml-unit.xml"/>

      <batchtest todir="${build.reports}"
        haltonerror="${junit.batchtest.haltonerror}"
        haltonfailure="${junit.batchtest.haltonfailure}"
        fork="${junit.batchtest.fork}">

         <fileset dir="${build.classes}">
            <patternset refid="jbossxb.includes"/>
         </fileset>
      </batchtest>
    </junit>
  </target>

   <!-- Test StAX JAS-173  -->
   <target name="tests-stax" depends="maybejars">
     <mkdir dir="${build.reports}"/>
     <mkdir dir="${build.testlog}"/>
     <junit dir="${module.output}"
       printsummary="${junit.printsummary}"
       haltonerror="${junit.haltonerror}"
       haltonfailure="${junit.haltonfailure}"
       fork="${junit.fork}"
       timeout="${junit.timeout}"
       jvm="${junit.jvm}">

       <jvmarg line="${junit.jvm.options}"/>
       <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
       <sysproperty key="build.testlog" value="${build.testlog}"/>
       <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
       <!-- Pass along any jbosstest.* system properties -->
       <syspropertyset>
          <propertyref prefix="jbosstest."/>
       </syspropertyset>

       <classpath>
         <pathelement location="${build.classes}"/>
         <pathelement location="${build.resources}"/>
         <path refid="tests.classpath"/>
       </classpath>

       <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/-->
       <sysproperty key="jboss-junit-configuration" value="tests-stax"/>
       <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                  usefile="${junit.formatter.usefile}"
                  extension="-tests-stax.xml"/>

       <batchtest todir="${build.reports}"
          haltonerror="${junit.batchtest.haltonerror}"
          haltonfailure="${junit.batchtest.haltonfailure}"
          fork="${junit.batchtest.fork}">

          <fileset dir="${build.classes}">
             <patternset refid="stax.includes"/>
          </fileset>
       </batchtest>
     </junit>
   </target>

    <!-- Run the Web Services Tests-->
   <target name="tests-webservice"
      description="Execute Web Services Related Tests">

      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         showoutput="${junit.showoutput}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="jbosstest.secure" value="true"/>

         <jvmarg value="-Djava.security.manager"/>
         <sysproperty key="java.security.policy" value="${build.resources}/security/tst.policy"/>
         <sysproperty key="java.security.auth.login.config" value="${build.resources}/security/auth.conf"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <!-- [JBAS-3969] IOException: unknown protocol: vfsfile -->
         <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <!-- The crimson parser cannot do schema validation, which we need for jaxrpc-mapping.xml -->
         <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}/security"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-webservice"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-webservice.xml"/>
         <formatter type="plain" usefile="${junit.formatter.usefile}"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/webservice/**/*TestCase.class"/>
               <exclude name="org/jboss/test/webservice/jbws309/**"/>
            </fileset>
         </batchtest>
      </junit>
   </target>
   
   <!-- Run the Web Services JAX-WS Tests-->
   <target name="tests-ws"
      description="Execute Web Services JAX-WS Related Tests">

      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         showoutput="${junit.showoutput}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="jbosstest.secure" value="true"/>

         <jvmarg value="-Djava.security.manager"/>
         <sysproperty key="java.security.policy" value="${build.resources}/security/tst.policy"/>
         <sysproperty key="java.security.auth.login.config" value="${build.resources}/security/auth.conf"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <!-- [JBAS-3969] IOException: unknown protocol: vfsfile -->
         <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <!-- The crimson parser cannot do schema validation, which we need for jaxrpc-mapping.xml -->
         <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}/security"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-webservice"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-ws.xml"/>
         <formatter type="plain" usefile="${junit.formatter.usefile}"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/ws/**/*TestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
    | Standard jaxr tests that should run successfully against a
    | JBoss server distribution build that contains jaxr.
   -->
   <!-- Test for JAXR under the Web Services Umbrella -->
   <target name="tests-scout-jaxr" >
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
            printsummary="${junit.printsummary}"
            haltonerror="${junit.haltonerror}"
            haltonfailure="${junit.haltonfailure}"
            fork="${junit.fork}"
            timeout="${junit.timeout}"
            jvm="${junit.jvm}"
            failureProperty="tests.failure">

         <!-- JPDA Debugging begin-->
         <!--
            <jvmarg value="-Xdebug"/>
            <jvmarg value="-Xnoagent"/>
            <jvmarg value="-Djava.compiler=NONE"/>
            <jvmarg value="-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8686"/>
         -->
         <!-- End JPDA Debuuging begin-->

         <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="javax.xml.registry.ConnectionFactoryClass" value="org.apache.ws.scout.registry.ConnectionFactoryImpl"/>
         <sysproperty key="jaxr.query.url" value="http://${node0}:8080/juddi/inquiry"/>
         <sysproperty key="jaxr.publish.url" value="http://${node0}:8080/juddi/publish"/>
         <sysproperty key="juddi.proxy.transportClass" value="org.jboss.jaxr.juddi.transport.SaajTransport"/>
         <sysproperty key="host.name" value="${node0}"/>
         <sysproperty key="jndi.bind.name" value="JAXR"/>
         <sysproperty key="jaxr.debug" value="true"/>
         <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <classpath>
           <pathelement location="${build.classes}"/>
	   <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-scout-jaxr"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-scout-jaxr.xml"/>
	 <formatter type="plain" usefile="${junit.formatter.usefile}"/>

	 <batchtest todir="${build.reports}"
	    haltonerror="${junit.batchtest.haltonerror}"
	    haltonfailure="${junit.batchtest.haltonfailure}"
	    fork="${junit.batchtest.fork}">

	    <fileset dir="${build.classes}">
	       <patternset refid="jaxr.includes"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   
   <!-- The scoped AOP tests need a classloader hook -->
   <target name="tests-aop-scoped"
      description="AOP tests requiring a native classloader hook">

      <!-- copy across the pluggable instrumentor -->
      <copy todir="${jboss.dist}/bin" file="${jboss.aop.lib}/pluggable-instrumentor.jar"/>
      <create-config baseconf="all" newconf="scoped-aop-jdk50">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="deploy-hasingleton/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>
      <server:start name="scoped-aop-jdk50"/>

	   <antcall target="run-tests-aop-scoped" inheritRefs="true"/>
      <server:stop name="scoped-aop-jdk50"/>

      <delete file="${jboss.dist}/bin/pluggable-instrumentor.jar"/>
   </target>
   <target name="tests-aop-scoped-generated-advisor"
      description="AOP tests requiring a native classloader hook for JDK 5.0">

      <!-- copy across the pluggable instrumentor -->
      <copy todir="${jboss.dist}/bin" file="${jboss.aop.lib}/pluggable-instrumentor.jar"/>
      <create-config baseconf="all" newconf="scoped-aop-generated-advisor">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="deploy-hasingleton/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>
      <server:start name="scoped-aop-generated-advisor"/>

       <run-junit junit.patternset="aop-with-classloader.includes"/>

      <server:stop name="scoped-aop-generated-advisor"/>

      <delete file="${jboss.dist}/bin/pluggable-instrumentor.jar"/>
   </target>
   <target name="run-tests-aop-scoped"
     description="AOP tests requiring a native classloader hook">
       <run-junit junit.patternset="aop-with-classloader.includes" junit.configuration="aop-scoped"/>
   </target>
   <!-- Test for ws-bpel integration -->
   <target name="tests-bpel">
      <!-- define tasks used in this target -->
      <taskdef name="webdbschema" classname="org.jbpm.bpel.ant.WebDBSchemaTask">
         <classpath refid="jbpm.bpel.classpath" />
      </taskdef>
      <taskdef name="webdeploy" classname="org.jbpm.bpel.ant.WebDeployTask">
         <classpath refid="jbpm.bpel.classpath" />
      </taskdef>
      <!-- Create the sso enabled tomcat config starting with the default config -->
      <create-config baseconf="default" newconf="jbpm-bpel">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>
      <server:start name="jbpm-bpel"/>
      <webdbschema operation="create" host="${node0}"/>
      <webdeploy par="${build.lib}/bpel-hello.par" host="${node0}" />
      <run-junit junit.patternset="jbpm-bpel.includes" junit.configuration="tests-bpel"/>
      <webdbschema operation="drop" host="${node0}"/>
      <server:stop name="jbpm-bpel"/>
   </target>

	
   <!-- ============================================= JBM Targets ============================= -->
	
   <!--  Starts two servers, run few simultaneous tests, kill the server only once and get the results of all the tests  -->
   <target name="tests-jbossmessaging-cluster"
   	   description="Run JBM in cluster">

  	  <delete dir="${jboss.dist}/server/jbm-cluster1" />
   	  <delete dir="${jboss.dist}/server/jbm-cluster2" />
      <create-config baseconf="all" newconf="jbm-cluster1">
         <patternset>
            <include name="conf/**"/>
            <include name="deploy/**"/>
            <include name="deployers/**"/>
            <include name="deploy-hasingleton/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>
      <create-config baseconf="all" newconf="jbm-cluster2">
         <patternset>
            <include name="conf/**"/>
             <include name="deploy/**"/>
             <include name="deployers/**"/>
             <include name="deploy-hasingleton/**"/>
             <include name="lib/**"/>
         </patternset>
      </create-config>

      <server:start name="jbm-cluster1"/>
      <server:start name="jbm-cluster2"/>

      <antcall target="exec-jbmcluster"/>

      <!--  I'm not stopping jbm-cluster2 as this server will be killed during the test -->            
      <server:stop name="jbm-cluster1"/>
   	   
   </target>
   
  <!-- Test the Messaging JMS provider -->
  <target name="exec-jbmcluster">
    <mkdir dir="${build.reports}"/>
    <mkdir dir="${build.testlog}"/>
    <junit dir="${module.output}"
      printsummary="${junit.printsummary}"
      haltonerror="${junit.haltonerror}"
      haltonfailure="${junit.haltonfailure}"
      fork="${junit.fork}"
      timeout="${junit.timeout}"
      jvm="${junit.jvm}">

      <jvmarg line="${junit.jvm.options}"/>
      <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
      <sysproperty key="build.testlog" value="${build.testlog}"/>
      <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
      <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
      <sysproperty key="jbosstest.server.host" value="${node0}"/>
      <sysproperty key="jbosstest.useJBM" value="true"/>
      
      <sysproperty key="jbosstest.cluster.node0" value="${node0}"/>
      <sysproperty key="jbosstest.cluster.node0.http.url" value="${node0.http.url}"/>
      <sysproperty key="jbosstest.cluster.node0.jndi.url" value="${node0.jndi.url}"/>
      <sysproperty key="jbosstest.cluster.node1" value="${node1}"/>
      <sysproperty key="jbosstest.cluster.node1.http.url" value="${node1.http.url}"/>
      <sysproperty key="jbosstest.cluster.node1.jndi.url" value="${node1.jndi.url}"/>
      

        <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

      <classpath>
        <pathelement location="${build.classes}"/>
        <pathelement location="${build.resources}"/>
        <pathelement location="${build.resources}/jbossmessaging"/>
        <pathelement location="${build.lib}/jbossmessagingtest.jar"/>
        <path refid="tests.classpath"/>
      </classpath>

      <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
      <sysproperty key="jboss-junit-configuration" value="tests-jbossmessaging-cluster"/>
      <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                 usefile="${junit.formatter.usefile}"
                 extension="-tests-jbossmessaging.xml"/>

      <batchtest todir="${build.reports}"
        haltonerror="${junit.batchtest.haltonerror}"
        haltonfailure="${junit.batchtest.haltonfailure}"
        fork="${junit.batchtest.fork}">
         <fileset dir="${build.classes}">
            <patternset refid="jbossmessaging-clustering.includes"/>
         </fileset>
      </batchtest>
    </junit>
   </target>
  

   


   <!--
     | Run JMS tests against the Messaging JMS provider
   -->
   <target name="tests-jbossmessaging"
      description="Run JMS tests against the Messaging JMS provider">

      <!-- Create a separate messaging config -->
      <create-config baseconf="default" newconf="jbossmessaging">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
			   <include name="lib/**"/>
         </patternset>
      </create-config>
	   <server:start name="jbossmessaging"/>
      <antcall target="tests-jbossmessaging-unit" />
      <server:stop name="jbossmessaging"/>
   </target>



  <!-- Test the Messaging JMS provider -->
  <target name="tests-jbossmessaging-unit">
    <mkdir dir="${build.reports}"/>
    <mkdir dir="${build.testlog}"/>
    <junit dir="${module.output}"
      printsummary="${junit.printsummary}"
      haltonerror="${junit.haltonerror}"
      haltonfailure="${junit.haltonfailure}"
      fork="${junit.fork}"
      timeout="${junit.timeout}"
      jvm="${junit.jvm}">

      <jvmarg line="${junit.jvm.options}"/>
      <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
      <sysproperty key="build.testlog" value="${build.testlog}"/>
      <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
      <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
      <sysproperty key="jbosstest.server.host" value="${node0}"/>
      <sysproperty key="jbosstest.useJBM" value="true"/>

        <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

      <classpath>
        <pathelement location="${build.classes}"/>
        <pathelement location="${build.resources}"/>
        <pathelement location="${build.resources}/jbossmessaging"/>
        <pathelement location="${build.lib}/jbossmessagingtest.jar"/>
        <path refid="tests.classpath"/>
      </classpath>

      <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
      <sysproperty key="jboss-junit-configuration" value="tests-jbossmessaging"/>
      <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                 usefile="${junit.formatter.usefile}"
                 extension="-tests-jbossmessaging.xml"/>

      <batchtest todir="${build.reports}"
        haltonerror="${junit.batchtest.haltonerror}"
        haltonfailure="${junit.batchtest.haltonfailure}"
        fork="${junit.batchtest.fork}">
         <fileset dir="${build.classes}">
            <patternset refid="jbossmessaging.includes"/>
         </fileset>
      </batchtest>
    </junit>
   </target>
  
   <!-- ========================================= END JBM Targets ============================= -->

  <target name="tests-classloader-leak">

    <mkdir dir="${build.reports}"/>
    <mkdir dir="${build.testlog}"/>
    <create-config baseconf="all" newconf="classloader-leak">
      <patternset>
        <include name="conf/**"/>
        <include name="deploy/**"/>
        <include name="deployers/**"/>
        <include name="lib/**"/>
      </patternset>
    </create-config>
    <server:start name="classloader-leak"/>
    
    <junit dir="${module.output}" printsummary="${junit.printsummary}" haltonerror="${junit.haltonerror}" haltonfailure="${junit.haltonfailure}" fork="${junit.fork}"
      timeout="${junit.timeout}" jvm="${junit.jvm}">

      <jvmarg line="${junit.jvm.options}"/>
      <!-- Used for JGroups -->
      <jvmarg value="-Dbind.address=${node0}"/>
      <sysproperty key="jboss.dist" value="${jboss.dist}"/>
      <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
      <sysproperty key="build.testlog" value="${build.testlog}"/>
      <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
      <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
      <sysproperty key="jbosstest.server.host" value="${node0}"/>
      <!-- Pass along any jbosstest.* system properties -->
      <syspropertyset>
        <propertyref prefix="jbosstest."/>
      </syspropertyset>
      <classpath>
        <pathelement location="${build.classes}"/>
        <pathelement location="${build.resources}"/>
        <path refid="tests.classpath"/>
      </classpath>
      
      <!--sysproperty key="jboss-junit-configuration" value="classloader-leak"/-->
      <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter" usefile="${junit.formatter.usefile}" extension="-ClassloaderLeak.xml"/>

      <batchtest todir="${build.reports}" haltonerror="${junit.batchtest.haltonerror}" haltonfailure="${junit.batchtest.haltonfailure}" fork="${junit.batchtest.fork}">

        <fileset dir="${build.classes}">
          <patternset refid="classloader-leak.includes"/>
          <patternset refid="badtest.excludes"/>
        </fileset>
      </batchtest>
    </junit>
    
    <server:stop  name="classloader-leak"/>
    
  </target>


   <!--
      | Run all database related tests
    -->
   <target name="tests-db" depends="run-db-tests, tests-report-html"/>

   <target name="run-db-tests" depends="maybejars">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="jbosstest.iterationcount" value="2"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-db"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                 usefile="${junit.formatter.usefile}"
                 extension="-tests-db.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="**/bank/**/*StressTestCase.class"/>
               <include name="**/bmp/**/*UnitTestCase.class"/>
               <include name="**/cmp2/**/*UnitTestCase.class"/>
               <include name="**/cmp2/**/*StressTestCase.class"/>
               <include name="**/dbtest/**/*UnitTestCase.class"/>
               <include name="**/deadlock/**/*StressTestCase.class"/>
               <include name="**/entityexc/**/*UnitTestCase.class"/>
               <include name="**/idgen/**/*UnitTestCase.class"/>
               <include name="**/perf/**/*UnitTestCase.class"/>
               <include name="**/testbean/**/*UnitTestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>


   <!--
      | Run testcases in a single directory by specifing the test directory
      | name in -Dtest=dirname in tests/dirname/test/**TestCase.class
    -->
   <target name="test" if="test"
      description="Execute a single test.">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <!-- Remove the test.log so each run has a fresh log -->
      <delete file="${build.testlog}/test.log"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         showoutput="${junit.showoutput}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <jvmarg value="-Djava.security.manager"/>
         <jvmarg value="-Dbind.address=${env.MYTESTIP_1}"/>
         <jvmarg value="-Djava.security.policy==${build.resources}/client.policy"/>
         <!-- Used for JGroups -->
         <jvmarg value="-Dbind.address=${node0}"/>
         <sysproperty key="jboss.dist" value="${jboss.dist}"/>
         <sysproperty key="jbosstest.deploy.dir" value="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>
         <sysproperty key="java.security.auth.login.config"
            value="${build.resources}/security/auth.conf"/>
         <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
         <sysproperty key="jboss.vfs.forceCopy" value="true"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <!-- Include for those tests that need common security resources -->
            <pathelement location="${build.resources}/security"/>
            <path refid="tests.classpath"/>
         </classpath>

         <formatter type="xml" usefile="${junit.formatter.usefile}"/>
         <formatter type="plain" usefile="${junit.formatter.usefile}"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/${test}/**/*TestCase.class"/>
               <patternset refid="badtest.excludes"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | Run iiop testcases in a single directory by specifing the test
      | directory name in -Dtest=dirname in tests/dirname/test/**TestCase.class
    -->
   <target name="iiop-test" depends="maybejars" if="test"
      description="Execute a single test.">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <!-- Remove the test.log so each run has a fresh log -->
      <delete file="${build.testlog}/test.log"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <sysproperty key="jboss.dist" value="${jboss.dist}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>

         <jvmarg value="-Dorg.omg.CORBA.ORBClass=org.jacorb.orb.ORB"/>
         <jvmarg value="-Dorg.omg.CORBA.ORBSingletonClass=org.jacorb.orb.ORBSingleton"/>
         <jvmarg value="-Djacorb.orb.print_version=off"/>
         <jvmarg value="-Djacorb.log.default.verbosity=0"/>
         <jvmarg value="-Djacorb.interop.strict_check_on_tc_creation=off"/>
         <jvmarg value="-Djacorb.log.loggerFactory=org.jboss.util.Log4jLoggerFactory"/>
         <jvmarg value="-Djacorb.security.ssl.client.supported_options=0"/>
         <jvmarg value="-Djacorb.security.ssl.client.required_options=0"/>
         <jvmarg value="-DORBInitRef.NameService=corbaloc::${node0}:3528/JBoss/Naming/root"/>
         <jvmarg value="-Dorg.omg.PortableInterceptor.ORBInitializerClass.org.jboss.tm.iiop.TxClientInterceptorInitializer"/>
         <jvmarg value="-Djava.security.manager"/>
         <sysproperty key="java.security.policy" value="${build.resources}/iiop/client.policy"/>
         <sysproperty key="log4j.properties" file="${build.resources}/log4j.properties"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
            <path refid="jboss.iiop.classpath"/>
         </classpath>

         <formatter type="xml" usefile="${junit.formatter.usefile}"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/${test}/**/*TestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | Run a single testcase by specifing the fully qualified class name
      | of the unit test using the test property, -Dtest=org.jboss.test....
      | Here you specify the testcase class, not the directory
    -->
   <target name="one-test" if="test"
      description="Execute a single test.">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <!-- Remove the test.log so each test has a fresh log -->
      <delete file="${build.testlog}/test.log"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         showoutput="${junit.showoutput}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>

         <!--
         <jvmarg value="-Xdebug"/>
         <jvmarg value="-Xnoagent"/>
         <jvmarg value="-Djava.compiler=NONE"/>
         <jvmarg value="-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005"/>
         -->

         <!-- Used for JGroups -->
         <jvmarg value="-Dbind.address=${node0}"/>
         <sysproperty key="jboss.dist" value="${jboss.dist}"/>
         <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>
         <!-- [JBAS-3969] IOException: unknown protocol: vfsfile -->
         <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="jbosstest.secure" value="true"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="jbosstest.resource1.server.host" value="${node2}"/>
         <sysproperty key="jbosstest.resource2.server.host" value="${node3}"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>
         <sysproperty key="java.security.auth.login.config"
            value="${build.resources}/security/auth.conf"/>
         <sysproperty key="javax.net.ssl.trustStore"
            value="${build.resources}/security/tst.keystore"/>
         <sysproperty key="org.jboss.security.ignoreHttpsHost" value="true"/>
         <sysproperty key="jboss.vfs.forceCopy" value="true"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <!-- Include for those tests that need common security resources -->
            <pathelement location="${build.resources}/security"/>
            <path refid="tests.classpath"/>
         </classpath>

         <formatter type="xml" usefile="${junit.formatter.usefile}"/>
         <formatter type="plain" usefile="${junit.formatter.usefile}"/>

         <test todir="${build.reports}" name="${test}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}"/>
      </junit>
   </target>

   <target name="one-test-debug" if="test"
      description="Execute a single test.">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <!-- Remove the test.log so each test has a fresh log -->
      <delete file="${build.testlog}/test.log"/>
      <junit dir="${module.output}"
        printsummary="${junit.printsummary}"
        haltonerror="${junit.haltonerror}"
        haltonfailure="${junit.haltonfailure}"
        fork="${junit.fork}"
        timeout="${junit.timeout}"
        jvm="${junit.jvm}">

          <jvmarg value="-verbose:gc"/>

          <jvmarg value="-Xdebug"/>
          <jvmarg value="-Xnoagent"/>
          <jvmarg value="-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8686"/>
          <jvmarg line="${junit.jvm.options}"/>

        <!-- Used for JGroups -->
        <jvmarg value="-Dbind.address=${node0}"/>
        <sysproperty key="jboss.dist" value="${jboss.dist}"/>
        <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>
        <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
        <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
        <sysproperty key="jbosstest.server.host" value="${node0}"/>
        <sysproperty key="build.testlog" value="${build.testlog}"/>
        <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
        <sysproperty key="jbosstest.secure" value="true"/>
        <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
        <sysproperty key="jbosstest.server.host" value="${node0}"/>
        <!-- Pass along any jbosstest.* system properties -->
        <syspropertyset>
           <propertyref prefix="jbosstest."/>
           <propertyref prefix="java.rmi."/>
           <propertyref prefix="node0"/>
           <propertyref prefix="node1"/>
        </syspropertyset>
        <sysproperty key="java.security.auth.login.config"
          value="${build.resources}/security/auth.conf"/>
        <sysproperty key="javax.net.ssl.trustStore"
          value="${build.resources}/security/tst.keystore"/>
        <sysproperty key="org.jboss.security.ignoreHttpsHost" value="true"/>

        <classpath>
          <pathelement location="${build.classes}"/>
          <pathelement location="${build.resources}"/>
          <!-- Include for those tests that need common security resources -->
          <pathelement location="${build.resources}/security"/>
          <path refid="tests.classpath"/>
        </classpath>

        <formatter type="plain" usefile="${junit.formatter.usefile}"/>
        <formatter type="xml" usefile="${junit.formatter.usefile}"/>

        <test todir="${build.reports}" name="${test}"
          haltonerror="${junit.batchtest.haltonerror}"
          haltonfailure="${junit.batchtest.haltonfailure}"
          fork="${junit.batchtest.fork}"/>
      </junit>
    </target>


   <!--
      | Run a single testcase by specifing the fully qualified class name
      | of the unit test using the test property, -Dtest=org.jboss.test....
      | Here you specify the testcase class, not the directory
    -->
   <target name="one-iiop-test" if="test"
      description="Execute a single test.">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <!-- Remove the test.log so each test has a fresh log -->
      <delete file="${build.testlog}/test.log"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
      	 showoutput="${junit.showoutput}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
<!--         <jvmarg value="-Xdebug"/>-->
<!--         <jvmarg value="-Xnoagent"/>-->
<!--         <jvmarg value="-Djava.compiler=NONE"/>-->
<!--         <jvmarg value="-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005"/>-->
         <!-- Used for JGroups -->
         <jvmarg value="-Dbind.address=${node0}"/>
         <jvmarg value="-Dorg.omg.CORBA.ORBClass=org.jacorb.orb.ORB"/>
         <jvmarg value="-Dorg.omg.CORBA.ORBSingletonClass=org.jacorb.orb.ORBSingleton"/>
         <jvmarg value="-Djacorb.orb.print_version=off"/>
         <jvmarg value="-Djacorb.log.default.verbosity=0"/>
         <jvmarg value="-Djacorb.interop.strict_check_on_tc_creation=off"/>
         <jvmarg value="-Djacorb.log.loggerFactory=org.jboss.util.Log4jLoggerFactory"/>
         <jvmarg value="-Djacorb.security.ssl.client.supported_options=0"/>
         <jvmarg value="-Djacorb.security.ssl.client.required_options=0"/>
         <jvmarg value="-DORBInitRef.NameService=corbaloc::${node0}:3528/JBoss/Naming/root"/>
         <jvmarg value="-Dorg.omg.PortableInterceptor.ORBInitializerClass.org.jboss.tm.iiop.TxClientInterceptorInitializer"/>
         <jvmarg value="-Djava.security.manager"/>
         <jvmarg value="-Djava.security.policy==${build.resources}/iiop/client.policy"/>
         <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="jbosstest.secure" value="true"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="jbosstest.resource1.server.host" value="${node2}"/>
         <sysproperty key="jbosstest.resource2.server.host" value="${node3}"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>
         <sysproperty key="java.security.auth.login.config"
            value="${build.resources}/security/auth.conf"/>
         <sysproperty key="javax.net.ssl.trustStore"
            value="${build.resources}/security/tst.keystore"/>
         <sysproperty key="org.jboss.security.ignoreHttpsHost" value="true"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <!-- Include for those tests that need common security resources -->
            <pathelement location="${build.resources}/security"/>
            <path refid="tests.classpath"/>
         </classpath>

         <formatter type="xml" usefile="${junit.formatter.usefile}"/>
         <formatter type="plain" usefile="${junit.formatter.usefile}"/>

         <test todir="${build.reports}" name="${test}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}"/>
      </junit>
   </target>

   <!-- Misc tests of the testing framework itself
   -->
   <target name="tests-apache"
      description="Test that apache can be started/stopped from ant">
      <apache location="${apache.location}" action-type="start"/>
      <start-sleep seconds="15"/>
      <apache location="${apache.location}" action-type="stop"/>
      <start-sleep seconds="5"/>
   </target>

   <target name="tests-jboss-cluster"
      description="Test that two jboss cluster nodes can be started/stopped from ant">
      <server:start name="node0"/>
      <server:start name="node1"/>
      <start-sleep seconds="60"/>
      <server:stop name="node0"/>
      <server:stop name="node1"/>
   </target>

   <property name="aspects.root" value="${project.root}/aspects"/>

   <target name="tests-aspects"
	description="Runs the aspects tests against ALL configuration">
      <ant antfile="${aspects.root}/build-test50.xml" inheritAll="false" dir="${aspects.root}"/>
      <ant antfile="${aspects.root}/build-test50.xml" inheritAll="false" dir="${aspects.root}" target="tests">
      	<property name="node0" value="${node0}"/>
   	</ant>
   </target>

   <target name="validate-server-configs"
      description="Validate the start/stop of the testsuite server configs">
      <!-- minimal -->
      <server:start name="minimal"/>
      <copy file="${build.lib}/shutdown.sar"
         todir="${jboss.dist}/server/minimal/deploy" />
      <echo message="Minimal server started, stopping"/>
      <sleep seconds="5"/>
      <delete file="${jboss.dist}/server/minimal/deploy/shutdown.sar" />
      <sleep seconds="7"/>

      <!-- minimal -->
      <server:start name="all"/>
      <server:stop name="all"/>

      <!-- tests-apache-tomcat-clustering -->
      <create-cluster-node conf="node0"/>
      <server:start name="node0" />
      <create-cluster-node conf="node1"/>
      <server:start name="node1"/>

      <server:stop name="node0"/>
      <server:stop name="node1"/>
      <apache location="${apache.location}" action-type="stop"/>

      <!-- Test the default UDP stack -->
      <antcall target="tests-clustering-configure">
         <param name="jboss-junit-configuration" value="udp"/>
      </antcall>
      <server:start name="cluster-udp-0"/>
      <server:start name="cluster-udp-1"/>
      <server:stop name="cluster-udp-0"/>
      <server:stop name="cluster-udp-1"/>

      <!-- Test a TCP stack.-->
      <antcall target="tests-clustering-configure">
         <param name="jboss-junit-configuration" value="tcp"/>
      </antcall>
      <server:start name="cluster-tcp-0"/>
      <server:start name="cluster-tcp-1"/>
      <server:stop name="cluster-tcp-0"/>
      <server:stop name="cluster-tcp-1"/>

      <!-- Test the field UDP stack -->
      <antcall target="tests-clustering-field-configure">
         <param name="cluster.includes.refid" value="cluster.field.includes"/>
         <param name="jboss-junit-configuration" value="udp"/>
         <param name="jbosstest.cluster.node0.config" value="cluster-field-udp-0"/>
         <param name="jbosstest.cluster.node1.config" value="cluster-field-udp-1"/>
      </antcall>

      <server:start name="cluster-field-udp-0"/>
      <server:start name="cluster-field-udp-1"/>
      <server:stop name="cluster-field-udp-0"/>
      <server:stop name="cluster-field-udp-1"/>
      <!-- Test the field TCP stack -->
      <antcall target="tests-clustering-field-configure">
         <param name="cluster.includes.refid" value="cluster.field.includes"/>
         <param name="jboss-junit-configuration" value="tcp"/>
         <param name="jbosstest.cluster.node0.config" value="cluster-field-tcp-0"/>
         <param name="jbosstest.cluster.node1.config" value="cluster-field-tcp-1"/>
      </antcall>

      <server:start name="cluster-field-tcp-0"/>
      <server:start name="cluster-field-tcp-1"/>
      <server:stop name="cluster-field-tcp-0"/>
      <server:stop name="cluster-field-tcp-1"/>

      <!-- Create the sso enabled tomcat config starting with the all config -->
      <create-cluster-sso-node newconf="tomcat-sso-cluster0"/>
      <create-cluster-sso-node newconf="tomcat-sso-cluster1"/>

      <echo message="Modifying the node0 and node1 Tomcat configuration for REPL_SYNC/UseJK"/>
      <http-cluster-node-config-change conf="tomcat-sso-cluster0"/>
      <http-cluster-node-config-change conf="tomcat-sso-cluster1"/>

      <server:start name="tomcat-sso-cluster0"/>
      <server:start name="tomcat-sso-cluster1"/>

      <server:stop name="tomcat-sso-cluster0"/>
      <server:stop name="tomcat-sso-cluster1"/>

      <!-- tomcat-webctx -->
      <create-config baseconf="default" newconf="tomcat-webctx"
         newconf-src="tomcat-webctx">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>

      <server:start name="tomcat-webctx"/>
      <server:stop name="tomcat-webctx"/>

      <!-- Test the example binding configuration -->
      <create-cluster-node conf="binding-manager1"/>
      <create-cluster-node conf="binding-manager2"/>
      <server:start name="binding-manager1"/>
      <server:start name="binding-manager2"/>

      <server:stop name="binding-manager1"/>
      <server:stop name="binding-manager2"/>
   </target>

   <!-- Reporting targets that generate reports from JUnit output.
   -->
   <target name="reports" depends="tests-report"
      description="Generates all reports."/>

   <target name="tests-report-clean">
      <delete dir="${build.reports}"/>
   </target>

   <target name="tests-report" depends="tests-report-html, tests-report-text, tests-report-xml">
      <tar tarfile="${module.output}/${TIMENOW}.tgz" compression="gzip" longfile="gnu">
         <tarfileset dir="${build.reports}/html" prefix="${TIMENOW}">
            <include name="**"/>
         </tarfileset>
      </tar>
   </target>

   <target name="tests-report-html" depends="compile-stylesheets">
      <mkdir dir="${build.reports}/html"/>
      <mkdir dir="${aspects.root}/output/reports"/>

      <junitreport todir="${build.reports}">
         <fileset dir="${build.reports}">
            <include name="TEST-*.xml"/>
         </fileset>
         <fileset dir="${aspects.root}/output/reports">
            <include name="TEST-*.xml"/>
         </fileset>
         <report format="frames"
            todir="${build.reports}/html"
            styledir="${build.stylesheets}"
            />
      </junitreport>
   </target>

   <!--
      | this currently spews logs of VariableReference crap, so it is turned
      | off by default.  Once this is fixed, it should be built after
      | tests-report-html
    -->
   <target name="tests-report-text" depends="tests-report-html">
      <mkdir dir="${build.reports}/text"/>

      <style basedir="${build.reports}"
         destdir="${build.reports}/text"
         extension=".txt"
         style="${build.stylesheets}/summary1b.xsl"
         includes="TESTS-TestSuites.xml">
         <param name="thedate" expression="${TIMENOW}"/>
         <param name="java_version" expression="${java.version}"/>
         <param name="java_vendor" expression="${java.vendor}"/>
         <param name="java_vm_specification_version" expression="${java.vm.specification.version}"/>
         <param name="java_vm_version" expression="${java.vm.version}"/>
         <param name="java_vm_name" expression="${java.vm.name}"/>
         <param name="java_vm_info" expression="${java.vm.info}"/>
         <param name="java_specification_version" expression="${java.specification.version}"/>
         <param name="java_class_version" expression="${java.class.version}"/>
         <param name="os_name" expression="${os.name}"/>
         <param name="os_arch" expression="${os.arch}"/>
         <param name="os_version" expression="${os.version}"/>
         <param name="builduid" expression="${TIMENOW}"/>
         <param name="results_web" expression="${results_web}"/>
      </style>
   </target>

   <target name="tests-report-xml" depends="tests-report-html">
      <mkdir dir="${build.reports}/xml"/>

      <style basedir="${build.reports}"
         destdir="${build.reports}/xml"
         extension=".xml"
         style="${build.stylesheets}/shortXmlSummary.xsl"
         includes="TESTS-TestSuites.xml">
         <param name="thedate" expression="${TIMENOW}"/>
         <param name="java_version" expression="${java.version}"/>
         <param name="java_vendor" expression="${java.vendor}"/>
         <param name="java_vm_specification_version"

            expression="${java.vm.specification.version}"/>
         <param name="java_vm_version" expression="${java.vm.version}"/>
         <param name="java_vm_name" expression="${java.vm.name}"/>
         <param name="java_vm_info" expression="${java.vm.info}"/>
         <param name="java_specification_version" expression="${java.specification.version}"/>
         <param name="java_class_version" expression="${java.class.version}"/>
         <param name="os_name" expression="${os.name}"/>
         <param name="os_arch" expression="${os.arch}"/>
         <param name="os_version" expression="${os.version}"/>
      </style>
   </target>

   <target name="tests-matrix" description="Executes only the version check compatibility suite. Use -Dmatrix-versions=[version container] for this task" depends="maybejars" if="matrix-versions"> 
 
     <fail message="Use -Dmatrix-versions=[version container] for this task" unless="matrix-versions"/>
     <fail message="Set -Djdk15= to a JDK1.5 installation" unless="HAVE_JDK_1.5"/>
     <!--<fail message="Set -Djdk16= to a JDK1.6 installation" unless="HAVE_JDK_1.6"/>-->
     
     <!-- testing interoperating with clients using the unified invokers over jboss remoting -->
     <test-compatibility client-version="4_2_3_GA" label="15c-15s" client-jdk="${jdk15}" server-jdk="${jdk15}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="4_2_3_GA" label="15c-16s" client-jdk="${jdk15}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="4_2_3_GA" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="4_2_x" label="15c-15s" client-jdk="${jdk15}" server-jdk="${jdk15}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="4_2_x" label="15c-16s" client-jdk="${jdk15}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="4_2_x" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_0_0_GA" label="15c-15s" client-jdk="${jdk15}" server-jdk="${jdk15}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_0_0_GA" label="15c-16s" client-jdk="${jdk15}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_0_0_GA" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_0_1_GA" label="15c-15s" client-jdk="${jdk15}" server-jdk="${jdk15}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_0_1_GA" label="15c-16s" client-jdk="${jdk15}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_0_1_GA" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_0_x" label="15c-15s" client-jdk="${jdk15}" server-jdk="${jdk15}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_0_x" label="15c-16s" client-jdk="${jdk15}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_0_x" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_1_x" label="15c-15s" client-jdk="${jdk15}" server-jdk="${jdk15}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_1_x" label="15c-16s" client-jdk="${jdk15}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_1_x" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <!-- testing interoperating with clients using the pooled invokers -->
     <test-compatibility-pooled-invokers label="15c-15s" client-version="4_2_3_GA" client-jdk="${jdk15}" server-jdk="${jdk15}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers label="15c-16s" client-version="4_2_3_GA" client-jdk="${jdk15}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers label="16c-16s" client-version="4_2_3_GA" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers label="15c-15s" client-version="4_2_x" client-jdk="${jdk15}" server-jdk="${jdk15}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers label="15c-16s" client-version="4_2_x" client-jdk="${jdk15}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers label="16c-16s" client-version="4_2_x" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers label="15c-15s" client-version="5_0_0_GA" client-jdk="${jdk15}" server-jdk="${jdk15}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers label="15c-16s" client-version="5_0_0_GA" client-jdk="${jdk15}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers label="16c-16s" client-version="5_0_0_GA" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers label="15c-15s" client-version="5_0_1_GA" client-jdk="${jdk15}" server-jdk="${jdk15}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers label="15c-16s" client-version="5_0_1_GA" client-jdk="${jdk15}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers label="16c-16s" client-version="5_0_1_GA" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>     
     <test-compatibility-pooled-invokers label="15c-15s" client-version="5_0_x" client-jdk="${jdk15}" server-jdk="${jdk15}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers label="15c-16s" client-version="5_0_x" client-jdk="${jdk15}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers label="16c-16s" client-version="5_0_x" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>     
     <test-compatibility-pooled-invokers label="15c-15s" client-version="5_1_x" client-jdk="${jdk15}" server-jdk="${jdk15}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers label="15c-16s" client-version="5_1_x" client-jdk="${jdk15}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers label="16c-16s" client-version="5_1_x" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>     
   </target>
 
  <macrodef name="test-compatibility-pooled-invokers">
    <attribute name="client-version"/>
    <attribute name="label"/>
    <attribute name="client-jdk"/>
    <attribute name="server-jdk"/>
    <attribute name="client-serialization-flag"/>    
    <attribute name="serialization-flag"/>
    <sequential>
      <start-jboss conf="default" jvmargs="-Xms128m -Xmx512m -XX:MaxPermSize=512m @{serialization-flag}" java.exec="@{server-jdk}/bin/java"/>
      <wait-on-host/>
      <antcall target="tests-standard-unit-matrix-version-pooled">
        <param name="matrix-configuration" value="@{client-version}-@{label}"/>
	<param name="junit-jvm-command" value="@{client-jdk}/bin/java"/>
        <param name="current-version-dir" value="${matrix-versions}/@{client-version}"/>
        <param name="client-serialization-flag" value="@{client-serialization-flag}"/>
      </antcall>
      <stop-jboss jvmargs="-Xms128m -Xmx512m @{serialization-flag}" java.exec="@{server-jdk}/bin/java"/>
      <sleep seconds="240"/>
    </sequential>
  </macrodef>

  <macrodef name="test-compatibility">
    <attribute name="client-version"/>
    <attribute name="label"/>
    <attribute name="client-jdk"/>
    <attribute name="server-jdk"/>
    <attribute name="client-serialization-flag"/>    
    <attribute name="serialization-flag"/>
    <sequential>
      <start-jboss conf="default" jvmargs="-Xms128m -Xmx512m -XX:MaxPermSize=512m @{serialization-flag}" java.exec="@{server-jdk}/bin/java"/>
      <wait-on-host/>
      <antcall target="tests-standard-unit-matrix-version">
        <param name="matrix-configuration" value="@{client-version}-@{label}"/>
	<param name="junit-jvm-command" value="@{client-jdk}/bin/java"/>
        <param name="current-version-dir" value="${matrix-versions}/@{client-version}"/>
        <param name="client-serialization-flag" value="@{client-serialization-flag}"/>
      </antcall>
      <stop-jboss jvmargs="-Xms128m -Xmx512m @{serialization-flag}" java.exec="@{server-jdk}/bin/java"/>
      <sleep seconds="240"/>
    </sequential>
  </macrodef>
 
   <target name="tests-standard-unit-matrix-version">
     <execute-matrix-unit test-name="testbyvalue" parameter-filter="org/jboss/test/testbyvalue/test/**/*TestCase.class"/>
     <execute-matrix-unit test-name="bmp" parameter-filter="org/jboss/test/bmp/**/*TestCase.class"/>
     <execute-matrix-unit test-name="cmp2" parameter-filter="org/jboss/test/cmp2/**/*TestCase.class"/>
   </target>
 
   <target name="tests-standard-unit-matrix-version-pooled">
     <execute-matrix-unit test-name="pooled-invoker" parameter-filter="org/jboss/test/pooled/test/**/BeanStressTestCase.class"/>
   </target>
 
   <macrodef name="execute-matrix-unit">
     <attribute name="test-name"/>
     <attribute name="parameter-filter"/>
     <sequential>
       <!-- this requires antcall as a property can't be redefined -->
       <antcall target="execute-matrix-unit-target">
         <param name="test-name" value="@{test-name}"/>
         <param name="parameter-filter" value="@{parameter-filter}"/>
       </antcall>
     </sequential>
   </macrodef>
 
   <target name="execute-matrix-unit-target">
     <echo message=">>>>>> Executing test=${test-name} filter=${parameter-filter}"/>
     <pathconvert pathSep="," dirSep="/" property="jbosstest.hometest">
       <path location="${build.classes}"/>
     </pathconvert>
 
     <pathconvert pathSep="," dirSep="/" property="jbosstest.executionlist">
       <path>
         <fileset dir="${build.classes}">
           <include name="${parameter-filter}"/>
           <!-- The following test excluded because they need jboss.jar to
                access the following classes not included with the client libs:
                org/jboss/ejb/plugins/cmp/jdbc/metadata/JDBCQueryMetaData
                org/jboss/metadata/ClientMetaData -->
           <exclude name="org/jboss/test/cmp2/commerce/QueryTest.class"/>
           <exclude name="org/jboss/test/cmp2/commerce/LimitOffsetTest.class"/>
           <exclude name="org/jboss/test/cmp2/commerce/CompleteUnitTestCase.class"/>
         </fileset>
       </path>
     </pathconvert>
 
     <junit dir="${module.output}" printsummary="${junit.printsummary}" haltonerror="${junit.haltonerror}" haltonfailure="${junit.haltonfailure}" fork="true"
       timeout="${junit.timeout}" jvm="${junit-jvm-command}">
 
       <jvmarg line="${junit.jvm.options}"/>
       <!-- Used for JGroups -->
       <jvmarg value="-Dbind.address=${node0}"/>
       <jvmarg value="${client-serialization-flag}"/>
       <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
       <sysproperty key="build.testlog" value="${build.testlog}"/>
       <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
       <sysproperty key="jboss-junit-configuration" value="${test-name}_${matrix-configuration}"/>
       <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
       <sysproperty key="jbosstest.server.host" value="${node0}"/>
       <!-- Pass along any jbosstest.* system properties -->
       <syspropertyset>
         <propertyref prefix="jbosstest."/>
       </syspropertyset>
       <classpath>
         <pathelement location="${build.classes}"/>
         <pathelement location="${build.resources}"/>
         <fileset dir="${current-version-dir}" includes="*.jar"/>
         <path refid="tests.classpath"/>
         <path refid="tests.compile.classpath"/>
       </classpath>
       <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter" usefile="${junit.formatter.usefile}"
         extension="-${test-name}_${matrix-configuration}.xml"/>
 
       <batchtest todir="${build.reports}" haltonerror="${junit.batchtest.haltonerror}" haltonfailure="${junit.batchtest.haltonfailure}" fork="${junit.batchtest.fork}">
 
         <fileset dir="${build.classes}">
           <include name="org/jboss/test/compatibility/test/matrix/MatrixTestContainer.class"/>
         </fileset>
       </batchtest>
     </junit>
 
   </target>
</project>
